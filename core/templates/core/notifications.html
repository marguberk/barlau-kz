{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="w-full flex">
    <!-- Боковая панель -->
    <div class="w-64 h-screen bg-white border-r border-zinc-200 flex flex-col justify-start items-start fixed left-0 bottom-0 sidebar">
        <div class="self-stretch px-5 py-6 relative flex flex-col justify-start items-start gap-2 sidebar-logo">
            <div class="py-1 inline-flex justify-start items-center gap-2">
                <img src="{% static 'core/img/logo.png' %}" alt="Barlau Logo" class="w-10 h-6">
                <div class="text-center justify-start text-black text-2xl font-semibold leading-normal">Barlau.kz</div>
            </div>
        </div>
        <div class="self-stretch flex-1 px-4 pt-2 pb-4 flex flex-col justify-start items-center gap-4 sidebar-menu">
            <div class="self-stretch flex flex-col justify-start items-start gap-1">
                <div class="self-stretch flex flex-col justify-start items-start">
                    <a href="{% url 'core:home' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2 relative">
                        <img src="{% static 'core/img/home.svg' %}" alt="Home" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/home.svg' %}" alt="Home" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Главная</div>
                    </a>
                    <a href="{% url 'core:tasks' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/check-square.svg' %}" alt="Tasks" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/check-square.svg' %}" alt="Tasks" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Задачи</div>
                    </a>
                    <a href="{% url 'core:map' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/location.svg' %}?v={% now 'U' %}" alt="Map" class="w-5 h-5 desktop-icon align-middle" onerror="this.onerror=null; this.src='/static/core/img/location.svg'">
                        <img src="{% static 'core/img/mobile/location.svg' %}" alt="Map" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Карта</div>
                    </a>
                    {% if request.user.role != 'DRIVER' %}
                    <a href="{% url 'core:trucks' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/truck.svg' %}" alt="Trucks" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/truck.svg' %}" alt="Trucks" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Грузовики</div>
                    </a>
                    <a href="{% url 'core:employees' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/employee.svg' %}" alt="Employees" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/employee.svg' %}" alt="Employees" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Сотрудники</div>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Основной контент -->
    <div class="ml-64 flex-1 min-h-screen bg-gray-50 relative main-content">
        <!-- Верхняя панель -->
        <div class="w-full h-20 px-8 py-5 bg-white flex justify-between items-center">
            <div class="justify-start text-zinc-950 text-2xl font-semibold leading-loose">Уведомления</div>
            <div class="flex justify-start items-center gap-3">
                <div class="flex justify-start items-start gap-2 relative">
                    <a href="{% url 'core:notifications' %}" class="w-10 h-10 px-3 py-2 bg-white rounded-lg shadow-[0px_1px_2px_0px_rgba(13,13,18,0.06)] outline outline-1 outline-offset-[-1px] outline-zinc-200 flex justify-center items-center gap-1.5 relative">
                        <img src="{% static 'core/img/bell-05.svg' %}" alt="Notifications" class="w-5 h-5 notification-bell">
                        <span id="notif-badge" class="absolute -top-2 -right-2 bg-red-500 rounded-full border-2 border-white flex items-center justify-center font-bold shadow-lg transition-all duration-200" style="min-width: 1.4rem; min-height: 1.4rem; font-size: 0.85rem; color: #fff; padding: 0 0.3em; display: none; align-items: center; justify-content: center;"></span>
                    </a>
                </div>
                <div class="flex justify-start items-center gap-1.5 relative">
                    {% if request.user.is_authenticated %}
                        <div class="relative group" id="user-menu">
                            {% if request.user.photo %}
                                <img class="w-8 h-8 rounded-full object-cover cursor-pointer" src="{{ request.user.photo.url }}" id="user-avatar" />
                            {% else %}
                                <img class="w-8 h-8 rounded-full object-cover cursor-pointer" src="{% static 'core/img/avatars/placeholder-ava.png' %}" id="user-avatar" />
                            {% endif %}
                            <div class="hidden group-hover:block absolute right-0 mt-2 w-44 bg-white border border-gray-200 rounded-lg shadow-lg z-50" id="user-dropdown">
                                <a href="{% url 'core:profile' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Профиль</a>
                                <a href="{% url 'core:custom-logout' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Выйти</a>
                            </div>
                        </div>
                    {% else %}
                        <img class="w-8 h-8 rounded-full object-cover" src="{% static 'core/img/avatars/placeholder-ava.png' %}" />
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Контент уведомлений -->
        <div class="w-full px-8 py-6">
            <!-- CSRF Token для AJAX-запросов -->
            {% csrf_token %}
            
            <!-- Кнопки управления -->
            <div class="flex justify-end items-center mb-6 gap-4">
                <button id="markAllReadBtn" class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1">
                    <div class="notification-action-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="mark-all-text">Отметить все как прочитанные</span>
                </button>
            </div>

            <!-- Список уведомлений -->
            <div id="notificationsList" class="space-y-2">
                <!-- Уведомления будут добавлены через JavaScript -->
            </div>

            <!-- Загрузка -->
            <div id="loadingIndicator" class="hidden">
                <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            </div>

            <!-- Нет уведомлений -->
            <div id="emptyState" class="hidden">
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <div class="empty-state-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 2H14M10 21.2361C10.5308 21.7111 11.2316 22 12 22C12.7684 22 13.4692 21.7111 14 21.2361M5.08493 18.5C4.27945 18.5 3.75557 17.7407 4.11579 17.0954L5.43842 14.7258C6.19069 13.3781 6.58234 11.892 6.58234 10.3852V9.76471C6.58234 8.11791 7.49804 6.6627 8.89823 5.78534C8.96478 5.74364 9.03243 5.70324 9.10113 5.6642C9.93938 5.1877 10.9337 4.91176 12 4.91176C13.0663 4.91176 14.0606 5.1877 14.8989 5.6642C14.9676 5.70324 15.0352 5.74364 15.1018 5.78534C16.502 6.6627 17.4177 8.11791 17.4177 9.76471V10.3852C17.4177 11.892 17.8093 13.3781 18.5616 14.7258L19.8842 17.0954C20.2444 17.7407 19.7205 18.5 18.9151 18.5H15H9H5.08493Z" stroke="#9ca3af" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Нет уведомлений</h3>
                    <p class="text-gray-600">У вас пока нет уведомлений</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Нижнее мобильное меню - показываем только на мобильных устройствах -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 hidden max-lg:block">
    <div class="flex justify-between items-center px-2">
        <a href="{% url 'core:home' %}" class="flex-1 flex flex-col items-center text-gray-600  relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/home.svg' %}" alt="Home" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1">Главная</span>
        </a>
        <a href="{% url 'core:tasks' %}" class="flex-1 flex flex-col items-center text-gray-600  relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/check-square.svg' %}" alt="Tasks" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1">Задачи</span>
        </a>
        <a href="{% url 'core:map' %}" class="flex-1 flex flex-col items-center text-gray-600  relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/location.svg' %}" alt="Map" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1">Карта</span>
        </a>
        {% if request.user.role != 'DRIVER' %}
        <a href="{% url 'core:trucks' %}" class="flex-1 flex flex-col items-center text-gray-600  relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/truck.svg' %}" alt="Trucks" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1">Грузовики</span>
        </a>
        <a href="{% url 'core:employees' %}" class="flex-1 flex flex-col items-center text-gray-600  relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/employee.svg' %}" alt="Employees" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1">Сотрудники</span>
        </a>
        {% endif %}
    </div>
</nav>

<style>
/* Карточки уведомлений в стиле задач - на всю ширину */
.notification-card {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0px 2px 4px -1px rgba(13,13,18,0.06);
    outline: 1px solid rgb(229 231 235);
    outline-offset: -1px;
    padding: 0.75rem 1.25rem;
    min-height: 56px;
    transition: box-shadow 0.15s, background 0.15s, outline-color 0.15s;
    position: relative;
    animation: fadeInUp 0.5s;
    gap: 1rem;
}

.notification-card.unread {
    border-left: 4px solid #2563eb;
    outline-color: #2563eb;
}

.notification-card:hover {
    box-shadow: 0px 4px 8px -2px rgba(13,13,18,0.10);
    background: #f9fafb;
    outline-color: rgb(209 213 219);
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(24px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Иконка уведомления */
.notification-icon {
    min-width: 2.5rem;
    min-height: 2.5rem;
    border-radius: 50%;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.notification-card.unread .notification-icon {
    background: #e0e7ff;
}

.notification-icon svg {
    width: 20px;
    height: 20px;
}

/* Контент уведомления - горизонтальный layout */
.notification-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 1rem;
    min-width: 0;
}

/* Основная информация */
.notification-main {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #1e293b;
    line-height: 1.2;
    margin-bottom: 0.1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.notification-message {
    color: #64748b;
    font-size: 0.85rem;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Мета информация - дата и ссылка */
.notification-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
}

.notification-date {
    color: #94a3b8;
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
    min-width: 90px;
}

.notification-link {
    color: #2563eb;
    font-weight: 500;
    font-size: 0.8rem;
    transition: color 0.2s;
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
    text-decoration: none;
}

.notification-link:hover {
    color: #1d4ed8;
    text-decoration: underline;
}

/* Действия */
.notification-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.notification-actions button {
    background: #f1f5f9;
    color: #2563eb;
    border: none;
    border-radius: 0.5rem;
    padding: 0.3rem 0.7rem;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    white-space: nowrap;
}

.notification-actions button:hover {
    background: #2563eb;
    color: #fff;
}

/* Иконки для кнопок действий */
.notification-action-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
}

.notification-action-icon svg {
    width: 100%;
    height: 100%;
}

/* Иконка пустого состояния */
.empty-state-icon {
    width: 48px;
    height: 48px;
    flex-shrink: 0;
}

.empty-state-icon svg {
    width: 100%;
    height: 100%;
}

/* Иконки в карточках уведомлений */
.notif-check-icon svg path {
    stroke: #16a34a;
}

.notif-chevron-icon {
    width: 12px;
    height: 12px;
    margin-left: 4px;
    flex-shrink: 0;
}

.notif-chevron-icon svg {
    width: 100%;
    height: 100%;
}

.notif-chevron-icon svg path {
    stroke: #2563eb;
}

/* Кнопки управления */
#markAllReadBtn {
    background: #f1f5f9;
    color: #2563eb;
    border-radius: 0.7rem;
    padding: 0.5rem 1.1rem;
    font-size: 1rem;
    font-weight: 500;
    transition: background 0.2s, color 0.2s;
    border: none;
    box-shadow: 0 1px 2px 0 rgba(37, 99, 235, 0.04);
}

#markAllReadBtn:hover {
    background: #2563eb;
    color: #fff;
}

/* Адаптивность */
@media (max-width: 1200px) {
    .notification-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3rem;
    }
    
    .notification-meta {
        align-self: stretch;
        justify-content: space-between;
    }
    
    .notification-title,
    .notification-message {
        white-space: normal;
        text-overflow: initial;
        overflow: visible;
    }
}

@media (max-width: 900px) {
    /* Компактный дизайн карточек для мобильных */
    .notification-card {
        padding: 1rem;
        min-height: 48px;
        gap: 0.75rem;
        border-radius: 12px;
    }
    
    /* Горизонтальный layout на мобильных */
    .notification-content {
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 0.75rem;
    }
    
    .notification-main {
        flex: 1;
        min-width: 0;
    }
    
    .notification-title {
        font-size: 0.9rem;
        margin-bottom: 0.05rem;
        line-height: 1.3;
    }
    
    .notification-message {
        font-size: 0.8rem;
        line-height: 1.2;
    }
    
    /* Мета информация компактно */
    .notification-meta {
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
        min-width: 80px;
    }
    
    .notification-date {
        font-size: 0.75rem;
        min-width: auto;
        text-align: right;
    }
    
    .notification-link {
        font-size: 0.75rem;
    }
    
    /* Компактные действия */
    .notification-actions {
        align-self: flex-start;
        flex-shrink: 0;
    }
    
    .notification-actions button {
        font-size: 0.7rem;
        padding: 0.2rem 0.45rem;
        border-radius: 0.4rem;
    }
    
    /* Компактная иконка */
    .notification-icon {
        min-width: 2rem;
        min-height: 2rem;
    }
    
    .notification-icon svg {
        width: 18px;
        height: 18px;
    }
    
    /* Адаптивная кнопка управления */
    .flex.justify-end.items-center.mb-6 {
        justify-content: center;
        margin-bottom: 1rem;
        padding: 0 1rem;
    }
    
    #markAllReadBtn {
        font-size: 0.9rem;
        padding: 0.7rem 1.2rem;
        gap: 0.4rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .mark-all-text {
        white-space: nowrap;
    }
}

/* Очень маленькие экраны */
@media (max-width: 480px) {
    .w-full.px-8.py-6 {
        padding: 1rem 1rem 1.5rem 1rem;
    }
    
    .notification-card {
        padding: 0.9rem;
        min-height: 44px;
        gap: 0.6rem;
        border-radius: 10px;
    }
    
    .notification-icon {
        min-width: 1.75rem;
        min-height: 1.75rem;
    }
    
    .notification-icon svg {
        width: 16px;
        height: 16px;
    }
    
    .notification-title {
        font-size: 0.85rem;
    }
    
    .notification-message {
        font-size: 0.75rem;
    }
    
    .notification-date {
        font-size: 0.7rem;
    }
    
    .notification-link {
        font-size: 0.7rem;
    }
    
    #markAllReadBtn {
        font-size: 0.9rem;
        padding: 0.7rem 1.2rem;
        gap: 0.4rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .notification-action-icon {
        width: 14px;
        height: 14px;
    }
}

@media (max-width: 1100px) {
    .fixed.bottom-0 {
        padding-top: 10px !important;
        height: 70px !important;
    }
    
    .main-content {
        padding-bottom: 120px !important;
    }
}

/* Иконка уведомлений в верхней панели */
.notification-bell {
    filter: brightness(0) saturate(100%) invert(50%) sepia(0%) saturate(0%) hue-rotate(142deg) brightness(96%) contrast(91%);
}

/* Скрыть атрибуцию Leaflet */
.leaflet-control-attribution { display: none !important; }

/* Быстрая анимация появления страницы */
.main-content {
    animation: pageFadeIn 0.3s ease-out;
}

@keyframes pageFadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Анимация появления карточек уведомлений */
.notification-card {
    animation: notificationCardFadeIn 0.2s ease-out;
}

@keyframes notificationCardFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
    let notifications = [];
    const notificationsList = document.getElementById('notificationsList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const emptyState = document.getElementById('emptyState');
    const markAllReadBtn = document.getElementById('markAllReadBtn');

    // Загрузка уведомлений
    async function loadNotifications(page = 1) {
        loadingIndicator.classList.remove('hidden');
        notificationsList.classList.add('hidden');
        emptyState.classList.add('hidden');

        let url = `/api/notifications/?page=${page}`;

        try {
            const response = await fetch(url, { credentials: 'same-origin' });
            if (!response.ok) {
                throw new Error('Ошибка API: ' + response.status);
            }
            notifications = await response.json();
            console.log('Notifications response', notifications);
            renderNotifications();
            updateNotifBadge();
        } catch (error) {
            console.error('Ошибка при загрузке уведомлений:', error);
            alert('Не удалось загрузить уведомления');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    // Отрисовка уведомлений
    function renderNotifications() {
        let allNotifications = Array.isArray(notifications) ? notifications : notifications.results || [];
        
        if (allNotifications.length === 0) {
            notificationsList.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }
        
        notificationsList.classList.remove('hidden');
        emptyState.classList.add('hidden');
        
        notificationsList.innerHTML = allNotifications.map(notification => {
            let cardClass = 'notification-card';
            let iconSvg = getNotificationIconSvg(notification.type, notification.title, notification.message);
            
            if (!notification.read) {
                cardClass += ' unread';
            }
            
            return `
                <div class="${cardClass}">
                    <div class="notification-icon">${iconSvg}</div>
                    <div class="notification-content">
                        <div class="notification-main">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                        </div>
                        <div class="notification-meta">
                            <div class="notification-date">${notification.created_at_display}</div>
                            ${notification.link ? `<a href="${notification.link}" class="notification-link">Подробнее <div class="notif-chevron-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18L15 12L9 6" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></a>` : ''}
                        </div>
                    </div>
                    <div class="notification-actions">
                        ${!notification.read ? `<button onclick="markAsRead('${notification.id}')"><div class="notif-check-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>Прочитано</button>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Получение SVG иконки для типа уведомления
    function getNotificationIconSvg(type, title = '', message = '') {
        // Проверяем по содержимому сообщения для уведомлений о транспорте
        if (type === 'SYSTEM' && (title.includes('транспорт') || message.includes('транспорт') || title.includes('Транспорт') || message.includes('Транспорт'))) {
            return '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.35746 15.2241H3.91814C2.85878 15.2241 2 14.3653 2 13.3059V5.0314C2 3.97197 2.85878 3.11316 3.91814 3.11316H10.3973C11.4567 3.11316 12.3155 3.97197 12.3155 5.0314V15.2241H7.79807M16.3211 9.21706H12.3155V4.98346H12.8324C13.174 4.98343 13.5094 5.0746 13.804 5.24755C14.0986 5.4205 14.3417 5.66895 14.5081 5.96726L16.3211 9.21706Z" stroke="#64748b" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.07814 16.8869C7.00585 16.8869 7.7579 16.1352 7.7579 15.2079C7.7579 14.2806 7.00585 13.5289 6.07814 13.5289C5.15043 13.5289 4.39838 14.2806 4.39838 15.2079C4.39838 16.1352 5.15043 16.8869 6.07814 16.8869Z" stroke="#64748b" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.9953 16.8869C14.923 16.8869 15.675 16.1352 15.675 15.2079C15.675 14.2806 14.923 13.5289 13.9953 13.5289C13.0675 13.5289 12.3155 14.2806 12.3155 15.2079C12.3155 16.1352 13.0675 16.8869 13.9953 16.8869Z" stroke="#64748b" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.7703 15.2241H16.6921C17.2362 15.2241 17.7031 14.8939 17.9035 14.423M18 10.9591C17.9111 9.98232 17.0898 9.2171 16.0899 9.2171H12.3155V15.2242" stroke="#64748b" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        }
        
        switch (type) {
            case 'TASK': 
                return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.5 12.5L10.5 14.5L15.5 9.5M7.2 20H16.8C17.9201 20 18.4802 20 18.908 19.782C19.2843 19.5903 19.5903 19.2843 19.782 18.908C20 18.4802 20 17.9201 20 16.8V7.2C20 6.0799 20 5.51984 19.782 5.09202C19.5903 4.71569 19.2843 4.40973 18.908 4.21799C18.4802 4 17.9201 4 16.8 4H7.2C6.0799 4 5.51984 4 5.09202 4.21799C4.71569 4.40973 4.40973 4.71569 4.21799 5.09202C4 5.51984 4 6.0799 4 7.2V16.8C4 17.9201 4 18.4802 4.21799 18.908C4.40973 19.2843 4.71569 19.5903 5.09202 19.782C5.51984 20 6.0799 20 7.2 20Z" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            case 'WAYBILL': 
            case 'TRANSPORT':
                return '<svg width="24" height="24" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.35746 15.2241H3.91814C2.85878 15.2241 2 14.3653 2 13.3059V5.0314C2 3.97197 2.85878 3.11316 3.91814 3.11316H10.3973C11.4567 3.11316 12.3155 3.97197 12.3155 5.0314V15.2241H7.79807M16.3211 9.21706H12.3155V4.98346H12.8324C13.174 4.98343 13.5094 5.0746 13.804 5.24755C14.0986 5.4205 14.3417 5.66895 14.5081 5.96726L16.3211 9.21706Z" stroke="#16a34a" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.07814 16.8869C7.00585 16.8869 7.7579 16.1352 7.7579 15.2079C7.7579 14.2806 7.00585 13.5289 6.07814 13.5289C5.15043 13.5289 4.39838 14.2806 4.39838 15.2079C4.39838 16.1352 5.15043 16.8869 6.07814 16.8869Z" stroke="#16a34a" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.9953 16.8869C14.923 16.8869 15.675 16.1352 15.675 15.2079C15.675 14.2806 14.923 13.5289 13.9953 13.5289C13.0675 13.5289 12.3155 14.2806 12.3155 15.2079C12.3155 16.1352 13.0675 16.8869 13.9953 16.8869Z" stroke="#16a34a" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.7703 15.2241H16.6921C17.2362 15.2241 17.7031 14.8939 17.9035 14.423M18 10.9591C17.9111 9.98232 17.0898 9.2171 16.0899 9.2171H12.3155V15.2242" stroke="#16a34a" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            case 'EXPENSE': 
                return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12L11 14L15 10M2.5 8.5L9.66667 17L21.5 5" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            case 'SYSTEM': 
                return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15A1.65 1.65 0 0 0 20.25 13.38L20.36 13.38A2.15 2.15 0 0 0 22 11.23V10.77A2.15 2.15 0 0 0 20.36 8.62L20.25 8.62A1.65 1.65 0 0 0 19.4 7L19.4 7A1.65 1.65 0 0 0 17.75 5.38L17.62 5.27A2.15 2.15 0 0 0 15.47 3.62H14.53A2.15 2.15 0 0 0 12.38 5.27L12.27 5.38A1.65 1.65 0 0 0 10.62 7V7A1.65 1.65 0 0 0 9 8.62L8.89 8.62A2.15 2.15 0 0 0 7.24 10.77V11.23A2.15 2.15 0 0 0 8.89 13.38L9 13.38A1.65 1.65 0 0 0 10.62 15V15A1.65 1.65 0 0 0 12.27 16.62L12.38 16.73A2.15 2.15 0 0 0 14.53 18.38H15.47A2.15 2.15 0 0 0 17.62 16.73L17.75 16.62A1.65 1.65 0 0 0 19.4 15Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            case 'DOCUMENT': 
                return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 6V12L16 14M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            default: 
                return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 2H14M10 21.2361C10.5308 21.7111 11.2316 22 12 22C12.7684 22 13.4692 21.7111 14 21.2361M5.08493 18.5C4.27945 18.5 3.75557 17.7407 4.11579 17.0954L5.43842 14.7258C6.19069 13.3781 6.58234 11.892 6.58234 10.3852V9.76471C6.58234 8.11791 7.49804 6.6627 8.89823 5.78534C8.96478 5.74364 9.03243 5.70324 9.10113 5.6642C9.93938 5.1877 10.9337 4.91176 12 4.91176C13.0663 4.91176 14.0606 5.1877 14.8989 5.6642C14.9676 5.70324 15.0352 5.74364 15.1018 5.78534C16.502 6.6627 17.4177 8.11791 17.4177 9.76471V10.3852C17.4177 11.892 17.8093 13.3781 18.5616 14.7258L19.8842 17.0954C20.2444 17.7407 19.7205 18.5 18.9151 18.5H15H9H5.08493Z" stroke="#64748b" stroke-width="2" stroke-linecap="round"/></svg>';
        }
    }

    // Отметить уведомление как прочитанное
    async function markAsRead(id) {
        try {
            await fetch(`/api/notifications/${id}/mark_read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                credentials: 'same-origin'
            });
            await loadNotifications();
        } catch (error) {
            console.error('Ошибка при отметке уведомления:', error);
            alert('Не удалось отметить уведомление как прочитанное');
        }
    }

    // Отметить все как прочитанные
    async function markAllAsRead() {
        try {
            await fetch('/api/notifications/mark_all_read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                credentials: 'same-origin'
            });
            await loadNotifications();
        } catch (error) {
            console.error('Ошибка при отметке всех уведомлений:', error);
            alert('Не удалось отметить все уведомления как прочитанные');
        }
    }

    markAllReadBtn.addEventListener('click', markAllAsRead);

    // Пагинация: подгрузка следующей страницы при прокрутке вниз
    let currentPage = 1;
    let isLoadingMore = false;
    window.addEventListener('scroll', async () => {
        if (isLoadingMore) return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            if (notifications.next) {
                isLoadingMore = true;
                try {
                    const response = await fetch(notifications.next, { credentials: 'same-origin' });
                    const more = await response.json();
                    notifications.results = notifications.results.concat(more.results);
                    notifications.next = more.next;
                    renderNotifications();
                } catch (e) { /* ignore */ }
                isLoadingMore = false;
            }
        }
    });

    // После renderNotifications добавляем обновление бейджа
    function updateNotifBadge() {
        let allNotifications = Array.isArray(notifications) ? notifications : notifications.results || [];
        let hasUnread = allNotifications.some(n => !n.read);
        const badge = document.getElementById('notif-badge');
        if (badge) {
            if (hasUnread) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
    }

    // Инициализация
    loadNotifications();

    document.addEventListener('DOMContentLoaded', function() {
        const avatar = document.getElementById('user-avatar');
        const dropdown = document.getElementById('user-dropdown');
        if (avatar && dropdown) {
            avatar.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', function() {
                dropdown.classList.add('hidden');
            });
        }
    });
</script>
{% endblock %} 