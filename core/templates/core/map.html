{% extends "core/base.html" %}
{% load static %}

{% block title %}Карта транспорта{% endblock %}

{% block extra_head %}
<!-- Подключаем Leaflet CSS и JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<!-- Font Awesome для иконок -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />

<style>
    #mapContainer {
        width: 100%;
        height: calc(100vh - 200px);
        min-height: 400px;
        z-index: 1;
    }
    
    .filter-panel {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    
    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .filter-body {
        margin-bottom: 10px;
    }
    
    .refresh-button {
        background-color: #4a8eff;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .refresh-button:hover {
        background-color: #3a7bed;
    }
    
    .vehicle-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .vehicle-marker i {
        font-size: 18px;
    }
    
    /* Пульсирующая анимация для маркера пользователя */
    .user-location-marker {
        width: 16px;
        height: 16px;
        background-color: #4a8eff;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 rgba(74, 142, 255, 0.4);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(74, 142, 255, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(74, 142, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(74, 142, 255, 0);
        }
    }
    
    .update-info {
        font-size: 0.8rem;
        color: #666;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <h2 class="text-2xl font-bold mb-4">Карта транспортных средств</h2>
    
    <div class="filter-panel">
        <div class="filter-header">
            <h4 class="font-semibold">Фильтры транспорта</h4>
            <button id="refreshButton" class="refresh-button">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
        </div>
        <div class="filter-body">
            <div class="mb-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox" id="filterAll" checked>
                    <span class="ml-2">Все типы</span>
                </label>
            </div>
            <div class="mb-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox vehicle-type" id="filterCar" data-type="car" checked>
                    <span class="ml-2">Легковые</span>
                </label>
            </div>
            <div class="mb-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox vehicle-type" id="filterTruck" data-type="truck" checked>
                    <span class="ml-2">Грузовые</span>
                </label>
            </div>
            <div class="mb-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox vehicle-type" id="filterSpecial" data-type="special" checked>
                    <span class="ml-2">Спецтехника</span>
                </label>
            </div>
        </div>
        <div class="update-info" id="lastUpdate">Последнее обновление: </div>
    </div>
    
    <!-- Контейнер карты с явными размерами -->
    <div id="mapContainer" style="width: 100%; height: 500px; position: relative;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Инициализация страницы карты');
    
    // Создаем карту с центром на Алматы
    var map = L.map('mapContainer', {
        zoomControl: true,
        attributionControl: true
    }).setView([43.238949, 76.889709], 12);
    
    console.log('Создание карты Leaflet');
    
    // Добавляем слой OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    console.log('Карта создана, загружаем местоположение пользователя');
    
    // Переменные для хранения маркеров
    var userMarker;
    var vehicleMarkers = {};
    
    // Фильтры транспорта
    var filters = {
        car: true,
        truck: true,
        special: true
    };
    
    // Демо-данные для транспортных средств
    var demoVehicles = [
        {
            id: 1, 
            number: "KZ 123 ABC", 
            type: "car", 
            status: "active",
            driver: {
                fullname: "Иванов Иван",
                current_latitude: 43.238949,
                current_longitude: 76.889709
            }
        },
        {
            id: 2, 
            number: "KZ 456 DEF", 
            type: "truck", 
            status: "active",
            driver: {
                fullname: "Петров Петр",
                current_latitude: 43.252863,
                current_longitude: 76.945870
            }
        },
        {
            id: 3, 
            number: "KZ 789 GHI", 
            type: "special", 
            status: "inactive",
            driver: {
                fullname: "Сидоров Сидор",
                current_latitude: 43.225211,
                current_longitude: 76.862957
            }
        }
    ];
    
    // Пытаемся получить местоположение пользователя
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            // Успех
            function(position) {
                console.log('Получены координаты пользователя:', position.coords.latitude, position.coords.longitude);
                var userLatLng = [position.coords.latitude, position.coords.longitude];
                
                // Создаем маркер пользователя
                var userIcon = L.divIcon({
                    className: 'user-location-marker',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                
                userMarker = L.marker(userLatLng, {icon: userIcon}).addTo(map);
                userMarker.bindPopup('Ваше местоположение').openPopup();
                
                // Центрируем карту на пользователе
                map.setView(userLatLng, 13);
            },
            // Ошибка
            function(error) {
                console.log('Ошибка получения местоположения:', error);
                // Используем данные по умолчанию
                loadVehicles();
            }
        );
    } else {
        console.log('Геолокация не поддерживается');
        loadVehicles();
    }
    
    // В любом случае загружаем транспортные средства
    loadVehicles();
    
    // Функция загрузки транспортных средств
    function loadVehicles() {
        console.log('Загружаем транспортные средства');
        
        // Очищаем существующие маркеры
        clearVehicleMarkers();
        
        // Используем демо-данные
        displayVehicles(demoVehicles);
        
        // Обновляем время последнего обновления
        updateLastUpdateTime();
    }
    
    // Отображение транспортных средств на карте
    function displayVehicles(vehicles) {
        console.log('Отображаем транспортные средства:', vehicles);
        
        vehicles.forEach(function(vehicle) {
            // Проверяем фильтры
            if (!filters[vehicle.type]) {
                return;
            }
            
            var latlng = [
                vehicle.driver.current_latitude,
                vehicle.driver.current_longitude
            ];
            
            // Определяем иконку по типу
            var iconClass;
            switch(vehicle.type) {
                case 'truck':
                    iconClass = 'fa-truck';
                    break;
                case 'special':
                    iconClass = 'fa-truck-monster';
                    break;
                default:
                    iconClass = 'fa-car';
            }
            
            // Цвет в зависимости от статуса
            var color = vehicle.status === 'active' ? '#28a745' : '#dc3545';
            
            // Создаем маркер
            var vehicleIcon = L.divIcon({
                className: 'vehicle-marker',
                html: '<i class="fas ' + iconClass + '" style="color: ' + color + '"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            var marker = L.marker(latlng, {icon: vehicleIcon}).addTo(map);
            
            // Добавляем всплывающее окно
            marker.bindPopup(
                '<div>' +
                '<h3 style="font-weight: bold; margin-bottom: 5px;">' + vehicle.number + '</h3>' +
                '<p><strong>Водитель:</strong> ' + vehicle.driver.fullname + '</p>' +
                '<p><strong>Тип:</strong> ' + getVehicleTypeName(vehicle.type) + '</p>' +
                '<p><strong>Статус:</strong> ' + (vehicle.status === 'active' ? 'Активен' : 'Неактивен') + '</p>' +
                '</div>'
            );
            
            // Сохраняем маркер
            vehicleMarkers[vehicle.id] = marker;
        });
    }
    
    // Очистка маркеров транспортных средств
    function clearVehicleMarkers() {
        for (var id in vehicleMarkers) {
            map.removeLayer(vehicleMarkers[id]);
        }
        vehicleMarkers = {};
    }
    
    // Обработчики событий
    document.getElementById('refreshButton').addEventListener('click', function() {
        loadVehicles();
    });
    
    // Фильтр "Все типы"
    document.getElementById('filterAll').addEventListener('change', function() {
        if (this.checked) {
            // Выбираем все
            document.querySelectorAll('.vehicle-type').forEach(function(checkbox) {
                checkbox.checked = true;
                filters[checkbox.dataset.type] = true;
            });
        }
        applyFilters();
    });
    
    // Фильтры по типам
    document.querySelectorAll('.vehicle-type').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            filters[this.dataset.type] = this.checked;
            
            // Если снят хоть один чекбокс, снимаем "Все типы"
            if (!this.checked) {
                document.getElementById('filterAll').checked = false;
            }
            
            // Если выбраны все, выбираем "Все типы"
            var allChecked = Array.from(document.querySelectorAll('.vehicle-type'))
                .every(function(cb) { return cb.checked; });
            
            if (allChecked) {
                document.getElementById('filterAll').checked = true;
            }
            
            applyFilters();
        });
    });
    
    // Функция применения фильтров
    function applyFilters() {
        clearVehicleMarkers();
        displayVehicles(demoVehicles);
    }
    
    // Обновление времени последнего обновления
    function updateLastUpdateTime() {
        var now = new Date();
        var timeString = now.toLocaleTimeString();
        document.getElementById('lastUpdate').textContent = 'Последнее обновление: ' + timeString;
    }
    
    // Получение названия типа транспорта
    function getVehicleTypeName(type) {
        switch(type) {
            case 'car': return 'Легковой';
            case 'truck': return 'Грузовой';
            case 'special': return 'Спецтехника';
            default: return 'Неизвестно';
        }
    }
    
    // Обновляем время последнего обновления
    updateLastUpdateTime();
    
    // Исправляем отображение карты, если есть проблемы с контейнером
    setTimeout(function() {
        map.invalidateSize();
    }, 100);
});
</script>
{% endblock %} 