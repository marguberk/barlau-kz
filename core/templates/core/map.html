{% extends "core/base.html" %}
{% load static %}

{% block title %}Карта транспорта - BARLAU.KZ{% endblock %}

{% block extra_head %}
<!-- Подключаем Leaflet CSS и JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<!-- Font Awesome для иконок -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />

<style>
    #mapContainer {
        width: 100%;
        height: calc(100vh - 200px);
        min-height: 400px;
        z-index: 1;
    }
    
    .filter-panel {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    
    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .filter-body {
        margin-bottom: 10px;
    }
    
    .refresh-button {
        background-color: #4a8eff;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .refresh-button:hover {
        background-color: #3a7bed;
    }
    
    .vehicle-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .vehicle-marker i {
        font-size: 18px;
    }
    
    /* Пульсирующая анимация для маркера пользователя */
    .user-location-marker {
        width: 16px;
        height: 16px;
        background-color: #4a8eff;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 rgba(74, 142, 255, 0.4);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(74, 142, 255, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(74, 142, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(74, 142, 255, 0);
        }
    }
    
    .update-info {
        font-size: 0.8rem;
        color: #666;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Карта транспорта</h1>
        <button id="refreshButton" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
            <i class="fas fa-sync-alt mr-2"></i>Обновить
        </button>
    </div>

    <div class="vehicle-counter">
        <div class="counter-item">
            <span class="counter-label">Всего транспортных средств</span>
            <span class="counter-value" id="totalVehicles">0</span>
        </div>
        <div class="counter-item">
            <span class="counter-label">В движении</span>
            <span class="counter-value" id="activeVehicles">0</span>
        </div>
        <div class="counter-item">
            <span class="counter-label">На стоянке</span>
            <span class="counter-value" id="stoppedVehicles">0</span>
        </div>
    </div>

    <div class="bg-white rounded-lg overflow-hidden shadow-sm mb-4">
        <div class="p-4 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold text-gray-800">Местоположение транспорта</h3>
                <div class="legend mt-2">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2563EB;"></div>
                        <span>В движении</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #6B7280;"></div>
                        <span>На стоянке</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #EF4444;"></div>
                        <span>Долгий простой</span>
                    </div>
                </div>
            </div>
            <div id="lastUpdate" class="text-sm text-gray-500">Последнее обновление: --:--:--</div>
        </div>
        <div id="mapContainer"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Инициализация страницы карты');
    
    // Создаем переменные для отслеживания местоположения
    let isDriverMode = false;
    let isTrackingEnabled = false;
    let watchPositionId = null;
    let userMarker = null;
    
    // Определяем роль пользователя через API запрос
    function checkUserRole() {
        fetch('/api/v1/map/')
            .then(response => response.json())
            .then(data => {
                isDriverMode = data.isDriverMode || false;
                
                if (isDriverMode) {
                    console.log('Режим водителя активирован');
                    // Показываем интерфейс для водителя
                    setupDriverInterface();
                    // Запрашиваем геолокацию
                    requestGeolocation();
                } else {
                    // Загружаем обычные данные для диспетчера/администратора
                    loadVehicles();
                }
            })
            .catch(error => {
                console.error('Ошибка при проверке роли пользователя:', error);
                // Если ошибка, пробуем загрузить демо-данные
                loadVehicles();
            });
    }
    
    // Функция настройки интерфейса для водителя
    function setupDriverInterface() {
        // Создаем контейнер для элементов управления водителя
        const driverControlsHtml = `
            <div id="driverControls" class="fixed bottom-20 left-0 right-0 bg-white p-4 shadow-md rounded-t-lg z-50">
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-medium mb-2">Режим водителя</h3>
                    <div class="status-indicator mb-3">
                        <span class="text-sm">Статус отслеживания: </span>
                        <span id="trackingStatus" class="text-sm font-semibold text-red-500">Выключено</span>
                    </div>
                    <div class="flex gap-3">
                        <button id="startTracking" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow">
                            Включить отслеживание
                        </button>
                        <button id="stopTracking" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg shadow hidden">
                            Приостановить
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Добавляем в DOM
        document.body.insertAdjacentHTML('beforeend', driverControlsHtml);
        
        // Добавляем обработчики событий
        document.getElementById('startTracking').addEventListener('click', startTracking);
        document.getElementById('stopTracking').addEventListener('click', stopTracking);
    }
    
    // Функция запроса геолокации
    function requestGeolocation() {
        if (!navigator.geolocation) {
            alert('Геолокация не поддерживается вашим браузером');
            return;
        }
        
        // Запрашиваем доступ к геолокации
        navigator.geolocation.getCurrentPosition(
            // Успешное получение координат
            position => {
                console.log('Геолокация получена:', position.coords.latitude, position.coords.longitude);
                
                // Показываем диалог с запросом на включение отслеживания
                if (confirm('Разрешить отслеживание вашего местоположения для отображения на карте?')) {
                    startTracking();
                }
            },
            // Ошибка при получении координат
            error => {
                console.error('Ошибка при получении геолокации:', error);
                alert('Для работы приложения необходим доступ к вашему местоположению. Пожалуйста, разрешите доступ в настройках браузера.');
            },
            // Опции
            { enableHighAccuracy: true }
        );
    }
    
    // Функция включения отслеживания
    function startTracking() {
        if (isTrackingEnabled) return;
        
        // Меняем статус
        isTrackingEnabled = true;
        document.getElementById('trackingStatus').textContent = 'Включено';
        document.getElementById('trackingStatus').classList.remove('text-red-500');
        document.getElementById('trackingStatus').classList.add('text-green-500');
        
        // Меняем видимость кнопок
        document.getElementById('startTracking').classList.add('hidden');
        document.getElementById('stopTracking').classList.remove('hidden');
        
        // Отправляем статус на сервер
        updateTrackingStatus(true);
        
        // Запускаем отслеживание
        watchPositionId = navigator.geolocation.watchPosition(
            // При обновлении координат
            position => {
                updateUserLocation(position.coords.latitude, position.coords.longitude);
            },
            // При ошибке
            error => {
                console.error('Ошибка при отслеживании:', error);
                stopTracking();
                alert('Ошибка при отслеживании местоположения: ' + error.message);
            },
            // Опции
            { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
        );
    }
    
    // Функция отключения отслеживания
    function stopTracking() {
        if (!isTrackingEnabled) return;
        
        // Меняем статус
        isTrackingEnabled = false;
        document.getElementById('trackingStatus').textContent = 'Выключено';
        document.getElementById('trackingStatus').classList.remove('text-green-500');
        document.getElementById('trackingStatus').classList.add('text-red-500');
        
        // Меняем видимость кнопок
        document.getElementById('startTracking').classList.remove('hidden');
        document.getElementById('stopTracking').classList.add('hidden');
        
        // Отправляем статус на сервер
        updateTrackingStatus(false);
        
        // Останавливаем отслеживание
        if (watchPositionId !== null) {
            navigator.geolocation.clearWatch(watchPositionId);
            watchPositionId = null;
        }
    }
    
    // Функция обновления местоположения на сервере
    function updateUserLocation(latitude, longitude) {
        console.log('Обновление местоположения:', latitude, longitude);
        
        // Обновляем маркер на карте
        updateDriverMarker(latitude, longitude);
        
        // Отправляем данные на сервер
        fetch('/api/v1/map/update_location/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                latitude: latitude,
                longitude: longitude
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка сети');
            }
            return response.json();
        })
        .then(data => {
            console.log('Местоположение успешно обновлено на сервере');
        })
        .catch(error => {
            console.error('Ошибка при обновлении местоположения:', error);
        });
    }
    
    // Функция обновления статуса отслеживания на сервере
    function updateTrackingStatus(enabled) {
        fetch('/api/v1/map/tracking_status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                tracking_enabled: enabled
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка сети');
            }
            return response.json();
        })
        .then(data => {
            console.log('Статус отслеживания обновлен на сервере:', data);
        })
        .catch(error => {
            console.error('Ошибка при обновлении статуса отслеживания:', error);
        });
    }
    
    // Функция обновления маркера водителя на карте
    function updateDriverMarker(latitude, longitude) {
        const position = [latitude, longitude];
        
        // Если маркер уже существует, обновляем его позицию
        if (userMarker) {
            userMarker.setLatLng(position);
        } else {
            // Иначе создаем новый маркер
            const driverIcon = L.divIcon({
                className: 'driver-marker',
                html: '<i class="fas fa-user" style="color: #2563EB;"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            userMarker = L.marker(position, {icon: driverIcon}).addTo(map);
            userMarker.bindPopup('<div class="text-center"><strong>Ваше местоположение</strong></div>');
            
            // Центрируем карту на положении водителя
            map.setView(position, 15);
        }
    }
    
    // Получение CSRF токена из cookies
    function getCsrfToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }
    
    // Создаем карту с центром на Алматы
    var map = L.map('mapContainer', {
        zoomControl: true,
        attributionControl: true
    }).setView([43.238949, 76.889709], 12);
    
    console.log('Создание карты Leaflet');
    
    // Добавляем стилизованный слой карты CartoDB Positron (светлый, серый стиль)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);
    
    console.log('Карта создана, проверяем роль пользователя');
    
    // Переменные для хранения маркеров
    var vehicleMarkers = {};
    
    // Демо-данные для транспортных средств (только грузовики)
    var demoVehicles = [
        {
            id: 1, 
            number: "KZ 456 DEF", 
            brand: "VOLVO FH",
            model: "460",
            status: "active",
            lastUpdate: new Date().getTime() - 5 * 60 * 1000, // 5 минут назад
            speed: 67,
            driver: {
                fullname: "Петров Петр",
                phone: "+7 (701) 234-5678",
                current_latitude: 43.252863,
                current_longitude: 76.945870
            }
        },
        {
            id: 2, 
            number: "KZ 789 GHI", 
            brand: "Mercedes-Benz",
            model: "Actros",
            status: "inactive",
            lastUpdate: new Date().getTime() - 35 * 60 * 1000, // 35 минут назад
            speed: 0,
            driver: {
                fullname: "Сидоров Сидор",
                phone: "+7 (702) 345-6789",
                current_latitude: 43.225211,
                current_longitude: 76.862957
            }
        },
        {
            id: 3, 
            number: "KZ 123 JKL", 
            brand: "Scania",
            model: "R500",
            status: "inactive",
            lastUpdate: new Date().getTime() - 75 * 60 * 1000, // 1 час 15 минут назад
            speed: 0,
            driver: {
                fullname: "Иванов Иван",
                phone: "+7 (705) 987-6543",
                current_latitude: 43.238949,
                current_longitude: 76.889709
            }
        }
    ];
    
    // Запрашиваем геолокацию пользователя в любом случае
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                console.log('Геолокация пользователя получена');
                
                // Если пользователь админ - просто показываем маркер
                if (!isDriverMode) {
                    const userLocation = [position.coords.latitude, position.coords.longitude];
                    const userIcon = L.divIcon({
                        className: 'user-location-marker',
                        html: '<i class="fas fa-user" style="color: #10B981;"></i>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });
                    
                    L.marker(userLocation, {icon: userIcon}).addTo(map)
                        .bindPopup('Ваше местоположение')
                        .openPopup();
                        
                    // Добавляем кнопку для центрирования на пользователе
                    const locateControl = L.control({position: 'topright'});
                    locateControl.onAdd = function() {
                        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                        div.innerHTML = '<a href="#" title="Мое местоположение" role="button" aria-label="Мое местоположение" style="display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;"><i class="fas fa-location-arrow"></i></a>';
                        div.onclick = function() {
                            map.setView(userLocation, 15);
                            return false;
                        };
                        return div;
                    };
                    locateControl.addTo(map);
                } else {
                    // Если пользователь водитель - спрашиваем, хочет ли отслеживаться
                    if (confirm('Разрешить отслеживание вашего местоположения для отображения на карте?')) {
                        startTracking();
                    }
                }
            },
            error => {
                console.error('Ошибка при получении геолокации:', error);
            }
        );
    }
    
    // Проверяем роль пользователя для основного интерфейса
    checkUserRole();
    
    // Функция загрузки транспортных средств
    function loadVehicles() {
        console.log('Загружаем транспортные средства');
        
        // Очищаем существующие маркеры
        clearVehicleMarkers();
        
        // Пытаемся загрузить данные с сервера
        fetch('/api/v1/map/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                if (data.vehicles && data.vehicles.length > 0) {
                    // Если есть данные с сервера, используем их
                    displayVehicles(data.vehicles);
                    updateCounters(data.vehicles);
                } else {
                    // Иначе используем демо-данные
                    displayVehicles(demoVehicles);
                    updateCounters(demoVehicles);
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных:', error);
                // В случае ошибки используем демо-данные
                displayVehicles(demoVehicles);
                updateCounters(demoVehicles);
            });
        
        // Обновляем время последнего обновления
        updateLastUpdateTime();
    }
    
    // Отображение транспортных средств на карте
    function displayVehicles(vehicles) {
        console.log('Отображаем транспортные средства:', vehicles);
        
        vehicles.forEach(function(vehicle) {
            var latlng = [
                vehicle.driver.current_latitude,
                vehicle.driver.current_longitude
            ];
            
            // Определяем цвет в зависимости от статуса и времени простоя
            var iconColor;
            var isActive = vehicle.status === 'active' && vehicle.speed > 0;
            var isLongStopped = vehicle.lastUpdate && (new Date().getTime() - vehicle.lastUpdate > 60 * 60 * 1000); // Больше часа простоя
            
            if (isActive) {
                iconColor = '#2563EB'; // Синий - активен в движении
            } else if (isLongStopped) {
                iconColor = '#EF4444'; // Красный - долгий простой
            } else {
                iconColor = '#6B7280'; // Серый - на стоянке
            }
            
            // Создаем маркер с соответствующим стилем
            var vehicleIcon = L.divIcon({
                className: isActive ? 'vehicle-marker active-marker' : 'vehicle-marker',
                html: '<i class="fas fa-truck" style="color: ' + iconColor + '"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            var marker = L.marker(latlng, {icon: vehicleIcon}).addTo(map);
            
            // Форматируем время последнего обновления
            var lastUpdateText = '';
            if (vehicle.lastUpdate) {
                var timeDiff = Math.floor((new Date().getTime() - vehicle.lastUpdate) / (60 * 1000)); // в минутах
                if (timeDiff < 60) {
                    lastUpdateText = timeDiff + ' мин. назад';
                } else {
                    var hours = Math.floor(timeDiff / 60);
                    var mins = timeDiff % 60;
                    lastUpdateText = hours + ' ч. ' + (mins > 0 ? mins + ' мин.' : '') + ' назад';
                }
            }
            
            // Добавляем всплывающее окно с подробной информацией
            marker.bindPopup(
                '<div class="p-2">' +
                '<h3 class="text-lg font-semibold mb-2">' + vehicle.brand + ' ' + vehicle.model + '</h3>' +
                '<p class="text-sm mb-1"><strong>Гос. номер:</strong> ' + vehicle.number + '</p>' +
                '<p class="text-sm mb-1"><strong>Водитель:</strong> ' + vehicle.driver.fullname + '</p>' +
                '<p class="text-sm mb-1"><strong>Телефон:</strong> ' + vehicle.driver.phone + '</p>' +
                '<p class="text-sm mb-1"><strong>Скорость:</strong> ' + vehicle.speed + ' км/ч</p>' +
                '<p class="text-sm"><strong>Последнее обновление:</strong> ' + lastUpdateText + '</p>' +
                '</div>'
            );
            
            // Сохраняем маркер
            vehicleMarkers[vehicle.id] = marker;
        });
    }
    
    // Очистка маркеров транспортных средств
    function clearVehicleMarkers() {
        for (var id in vehicleMarkers) {
            map.removeLayer(vehicleMarkers[id]);
        }
        vehicleMarkers = {};
    }
    
    // Обновление счетчиков транспорта
    function updateCounters(vehicles) {
        var total = vehicles.length;
        var active = vehicles.filter(v => v.status === 'active' && v.speed > 0).length;
        var stopped = total - active;
        
        document.getElementById('totalVehicles').textContent = total;
        document.getElementById('activeVehicles').textContent = active;
        document.getElementById('stoppedVehicles').textContent = stopped;
    }
    
    // Обновление времени последнего обновления
    function updateLastUpdateTime() {
        var now = new Date();
        var timeString = now.toLocaleTimeString();
        document.getElementById('lastUpdate').textContent = 'Последнее обновление: ' + timeString;
    }
    
    // Обработчик нажатия на кнопку обновления
    document.getElementById('refreshButton').addEventListener('click', function() {
        loadVehicles();
    });
    
    // Запускаем автоматическое обновление каждые 5 минут
    setInterval(loadVehicles, 5 * 60 * 1000);
    
    // Исправляем отображение карты, если есть проблемы с контейнером
    setTimeout(function() {
        map.invalidateSize();
    }, 100);
});
</script>
{% endblock %} 
