{% extends "core/base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Заголовок и кнопка добавления -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Задачи</h1>
            {% if user.role == 'DIRECTOR' or user.role == 'SUPERADMIN' or user.is_superuser %}
            <button id="addTaskBtn" 
                    class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <i class="fas fa-plus mr-2"></i>Добавить задачу
            </button>
            {% endif %}
        </div>

        <!-- Фильтры -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Поиск -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Поиск</label>
                    <div class="relative">
                        <input type="text" id="searchInput" 
                               class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm placeholder:text-gray-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
                               placeholder="Поиск по названию...">
                        <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                    </div>
                </div>

                <!-- Статус -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Статус</label>
                    <select id="statusFilter" 
                            class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500">
                        <option value="">Все статусы</option>
                        <option value="NEW">Новые</option>
                        <option value="IN_PROGRESS">В работе</option>
                        <option value="COMPLETED">Завершенные</option>
                        <option value="CANCELLED">Отмененные</option>
                    </select>
                </div>

                <!-- Приоритет -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Приоритет</label>
                    <select id="priorityFilter"
                            class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500">
                        <option value="">Все приоритеты</option>
                        <option value="HIGH">Высокий</option>
                        <option value="MEDIUM">Средний</option>
                        <option value="LOW">Низкий</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Список задач -->
        <div id="tasksList" class="space-y-4">
            <!-- Задачи будут добавлены через JavaScript -->
        </div>

        <!-- Загрузка -->
        <div id="loadingIndicator" class="hidden">
            <div class="flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        </div>

        <!-- Нет задач -->
        <div id="emptyState" class="hidden">
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">Нет задач</h3>
                <p class="text-gray-600">Задачи пока не созданы</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления/редактирования задачи -->
<div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white rounded-xl shadow-lg">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modalTitle" class="text-lg font-semibold">Новая задача</h3>
            <button class="closeModal text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="taskForm" class="p-4 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Название</label>
                <input type="text" name="title" required
                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                <textarea name="description" rows="4" required
                          class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Приоритет</label>
                    <select name="priority" required
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="LOW">Низкий</option>
                        <option value="MEDIUM" selected>Средний</option>
                        <option value="HIGH">Высокий</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Срок выполнения</label>
                    <input type="datetime-local" name="due_date" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Исполнитель</label>
                    <select name="assigned_to" required
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <!-- Список исполнителей будет добавлен через JavaScript -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Транспорт</label>
                    <select name="vehicle"
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Не выбран</option>
                        <!-- Список транспорта будет добавлен через JavaScript -->
                    </select>
                </div>
            </div>
            <div class="pt-4 border-t flex justify-end space-x-3">
                <button type="button" class="closeModal px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Отмена
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    Сохранить
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Глобальные переменные
    let tasks = [];
    let currentTaskId = null;
    const tasksList = document.getElementById('tasksList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const emptyState = document.getElementById('emptyState');
    const taskModal = document.getElementById('taskModal');
    const modalTitle = document.getElementById('modalTitle');
    const taskForm = document.getElementById('taskForm');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');

    // Загрузка задач
    async function loadTasks() {
        loadingIndicator.classList.remove('hidden');
        tasksList.classList.add('hidden');
        emptyState.classList.add('hidden');

        try {
            const response = await fetch('/api/v1/tasks/');
            const data = await response.json();
            tasks = data.results;
            renderTasks();
        } catch (error) {
            console.error('Ошибка при загрузке задач:', error);
            alert('Не удалось загрузить задачи');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    // Отрисовка задач
    function renderTasks() {
        let filteredTasks = tasks;

        // Применяем фильтры
        const searchQuery = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const priorityValue = priorityFilter.value;

        if (searchQuery) {
            filteredTasks = filteredTasks.filter(task => 
                task.title.toLowerCase().includes(searchQuery) ||
                task.description.toLowerCase().includes(searchQuery)
            );
        }

        if (statusValue) {
            filteredTasks = filteredTasks.filter(task => task.status === statusValue);
        }

        if (priorityValue) {
            filteredTasks = filteredTasks.filter(task => task.priority === priorityValue);
        }

        if (filteredTasks.length === 0) {
            tasksList.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        tasksList.classList.remove('hidden');
        emptyState.classList.add('hidden');

        tasksList.innerHTML = filteredTasks.map(task => `
            <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <h3 class="font-medium text-gray-800">${task.title}</h3>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusStyle(task.status)}">${getStatusText(task.status)}</span>
                            <span class="px-2 py-1 text-xs rounded-full ${getPriorityStyle(task.priority)}">${getPriorityText(task.priority)}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-4">${task.description}</p>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-user text-gray-400"></i>
                                <span>${task.assigned_to_details.first_name} ${task.assigned_to_details.last_name}</span>
                            </div>
                            ${task.vehicle_details ? `
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-truck text-gray-400"></i>
                                    <span>${task.vehicle_details.brand} ${task.vehicle_details.model}</span>
                                </div>
                            ` : ''}
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-clock text-gray-400"></i>
                                <span>До ${new Date(task.due_date).toLocaleString('ru')}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-calendar text-gray-400"></i>
                                <span>Создано ${new Date(task.created_at).toLocaleString('ru')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editTask(${task.id})" class="p-2 text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="changeStatus(${task.id})" class="p-2 text-green-600 hover:text-green-800">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Стили для статусов и приоритетов
    function getStatusStyle(status) {
        switch (status) {
            case 'NEW': return 'bg-blue-100 text-blue-800';
            case 'IN_PROGRESS': return 'bg-yellow-100 text-yellow-800';
            case 'COMPLETED': return 'bg-green-100 text-green-800';
            case 'CANCELLED': return 'bg-gray-100 text-gray-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function getPriorityStyle(priority) {
        switch (priority) {
            case 'HIGH': return 'bg-red-100 text-red-800';
            case 'MEDIUM': return 'bg-orange-100 text-orange-800';
            case 'LOW': return 'bg-green-100 text-green-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'NEW': return 'Новая';
            case 'IN_PROGRESS': return 'В работе';
            case 'COMPLETED': return 'Завершена';
            case 'CANCELLED': return 'Отменена';
            default: return status;
        }
    }

    function getPriorityText(priority) {
        switch (priority) {
            case 'HIGH': return 'Высокий';
            case 'MEDIUM': return 'Средний';
            case 'LOW': return 'Низкий';
            default: return priority;
        }
    }

    // Управление модальным окном
    function openModal() {
        taskModal.classList.remove('hidden');
    }

    function closeModal() {
        taskModal.classList.add('hidden');
        taskForm.reset();
        currentTaskId = null;
    }

    // Редактирование задачи
    async function editTask(id) {
        currentTaskId = id;
        modalTitle.textContent = 'Редактировать задачу';
        
        const task = tasks.find(t => t.id === id);
        if (task) {
            const form = taskForm;
            form.title.value = task.title;
            form.description.value = task.description;
            form.priority.value = task.priority;
            form.due_date.value = task.due_date.slice(0, 16);
            form.assigned_to.value = task.assigned_to;
            form.vehicle.value = task.vehicle || '';
            
            openModal();
        }
    }

    // Изменение статуса
    async function changeStatus(id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;

        let newStatus;
        switch (task.status) {
            case 'NEW': newStatus = 'IN_PROGRESS'; break;
            case 'IN_PROGRESS': newStatus = 'COMPLETED'; break;
            default: return;
        }

        try {
            const response = await fetch(`/api/v1/tasks/${id}/change_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                await loadTasks();
            } else {
                const data = await response.json();
                alert(data.detail || 'Не удалось изменить статус задачи');
            }
        } catch (error) {
            console.error('Ошибка при изменении статуса:', error);
            alert('Не удалось изменить статус задачи');
        }
    }

    // Обработчики событий
    if (addTaskBtn) {
        addTaskBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Новая задача';
            openModal();
        });
    }

    document.querySelectorAll('.closeModal').forEach(btn => {
        btn.addEventListener('click', closeModal);
    });

    taskModal.addEventListener('click', (e) => {
        if (e.target === taskModal) {
            closeModal();
        }
    });

    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(taskForm);
        const data = Object.fromEntries(formData.entries());

        try {
            const url = currentTaskId ? 
                `/api/v1/tasks/${currentTaskId}/` : 
                '/api/v1/tasks/';
            
            const response = await fetch(url, {
                method: currentTaskId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal();
                await loadTasks();
            } else {
                const responseData = await response.json();
                alert(responseData.detail || 'Не удалось сохранить задачу');
            }
        } catch (error) {
            console.error('Ошибка при сохранении задачи:', error);
            alert('Не удалось сохранить задачу');
        }
    });

    // Фильтры
    searchInput.addEventListener('input', renderTasks);
    statusFilter.addEventListener('change', renderTasks);
    priorityFilter.addEventListener('change', renderTasks);

    // Инициализация
    loadTasks();
</script>
{% endblock %} 