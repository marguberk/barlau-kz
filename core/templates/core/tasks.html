{% extends "core/base.html" %}
{% load static %}

{% block title %}Задачи | BARLAU.KZ{% endblock %}

<!-- Принудительное обновление кэша -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

{% block content %}
<div class="w-full flex">
    <!-- Боковая панель -->
    <div class="w-64 h-screen bg-white border-r border-zinc-200 flex flex-col justify-start items-start fixed left-0 bottom-0 sidebar">
        <div class="self-stretch px-5 py-6 relative flex flex-col justify-start items-start gap-2 sidebar-logo">
            <div class="py-1 inline-flex justify-start items-center gap-2">
                <img src="{% static 'core/img/logo.png' %}" alt="Barlau Logo" class="w-10 h-6">
                <div class="text-center justify-start text-black text-2xl font-semibold leading-normal">Barlau.kz</div>
            </div>
        </div>
        <div class="self-stretch flex-1 px-4 pt-2 pb-4 flex flex-col justify-start items-center gap-4 sidebar-menu">
            <div class="self-stretch flex flex-col justify-start items-start gap-1">
                <div class="self-stretch flex flex-col justify-start items-start">
                    <a href="{% url 'core:home' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2 relative">
                        <img src="{% static 'core/img/home.svg' %}" alt="Home" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/home.svg' %}" alt="Home" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Главная</div>
                    </a>
                    <a href="{% url 'core:tasks' %}" class="self-stretch px-3 py-3.5 bg-gray-50 rounded-lg inline-flex items-center gap-2 relative">
                        <div class="w-1 h-6 left-0 top-[calc(50%-12px)] absolute bg-blue-600 rounded-tr-lg rounded-br-lg"></div>
                        <img src="{% static 'core/img/check-square.svg' %}" alt="Tasks" class="w-5 h-5 desktop-icon">
                        <img src="{% static 'core/img/mobile/check-square.svg' %}" alt="Tasks" class="mobile-icon hidden w-5 h-5">
                        <div class="flex-1 text-blue-600 text-base font-medium leading-normal tracking-tight">Задачи</div>
                    </a>
                    <a href="{% url 'core:map' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/location.svg' %}?v={% now 'U' %}" alt="Map" class="w-5 h-5 desktop-icon align-middle" onerror="this.onerror=null; this.src='/static/core/img/location.svg'">
                        <img src="{% static 'core/img/mobile/location.svg' %}" alt="Map" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Карта</div>
                    </a>
                    <a href="{% url 'core:trucks' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/truck.svg' %}" alt="Trucks" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/truck.svg' %}" alt="Trucks" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Грузовики</div>
                    </a>
                    <a href="{% url 'core:employees' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/employee.svg' %}" alt="Employees" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/employee.svg' %}" alt="Employees" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Сотрудники</div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="ml-64 flex-1 min-h-screen bg-white relative main-content">
        <!-- Верхняя панель -->
        <div class="w-full h-20 px-8 py-5 bg-white flex justify-between items-center border-b border-gray-200">
            <div class="justify-start text-zinc-950 text-2xl font-semibold leading-loose">Задачи</div>
            <div class="flex justify-start items-center gap-3">
                <div class="flex justify-start items-start gap-2">
                    <a href="{% url 'core:notifications' %}" class="w-10 h-10 px-3 py-2 bg-white rounded-lg shadow-[0px_1px_2px_0px_rgba(13,13,18,0.06)] outline outline-1 outline-offset-[-1px] outline-zinc-200 flex justify-center items-center gap-1.5 relative">
                        <img src="{% static 'core/img/bell.svg' %}" alt="Notifications" class="w-5 h-5">
                        <span id="notif-badge" class="absolute -top-2 -right-2 bg-red-500 rounded-full border-2 border-white flex items-center justify-center font-bold shadow-lg transition-all duration-200" style="min-width: 1.4rem; min-height: 1.4rem; font-size: 0.85rem; color: #fff; padding: 0 0.3em; display: none; align-items: center; justify-content: center;"></span>
                    </a>
                </div>
                <div class="flex justify-start items-center gap-1.5 relative">
                    {% if request.user.is_authenticated %}
                        <div class="relative group" id="user-menu">
                        {% if request.user.photo %}
                                <img class="w-8 h-8 rounded-full object-cover cursor-pointer" src="{{ request.user.photo.url }}" id="user-avatar" />
                        {% else %}
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center cursor-pointer" id="user-avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        {% endif %}
                            <div class="hidden group-hover:block absolute right-0 mt-2 w-44 bg-white border border-gray-200 rounded-lg shadow-lg z-50" id="user-dropdown">
                                <a href="{% url 'core:profile' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Профиль</a>
                                <a href="{% url 'core:custom-logout' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Выйти</a>
                            </div>
                        </div>
                    {% else %}
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- CSRF Token -->
        <div style="display: none">{% csrf_token %}</div>

        <!-- Данные пользователя для JavaScript -->
        {{ request.user.id|json_script:"user-id" }}
        {{ request.user.role|json_script:"user-role" }}
        {{ request.user.username|json_script:"user-name" }}

        <!-- Контент задач -->
        <div class="w-full px-8 py-6">
            <!-- Статусные группы -->
            <div class="space-y-6">
                <!-- К выполнению группа -->
                <div>
                    <!-- Заголовок статуса -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                            <h3 class="text-base font-medium text-gray-900">К выполнению</h3>
                            <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-sm font-medium" id="todo-count">0</span>
                        </div>
                    </div>
                    <!-- Карточки задач -->
                    <div id="todo-tasks" class="space-y-2">
                        <!-- Задачи К выполнению будут загружены здесь -->
                    </div>
                </div>
                
                <!-- В работе группа -->
                <div>
                    <!-- Заголовок статуса -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <h3 class="text-base font-medium text-gray-900">В работе</h3>
                            <span class="bg-amber-50 text-amber-600 px-2 py-0.5 rounded-full text-sm font-medium" id="progress-count">0</span>
                        </div>
                    </div>
                    <!-- Карточки задач -->
                    <div id="progress-tasks" class="space-y-2">
                        <!-- Задачи В работе будут загружены здесь -->
            </div>
        </div>

                <!-- Выполнено группа -->
                <div>
                    <!-- Заголовок статуса -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <h3 class="text-base font-medium text-gray-900">Выполнено</h3>
                            <span class="bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full text-sm font-medium" id="done-count">0</span>
                        </div>
                    </div>
                    <!-- Карточки задач -->
                    <div id="done-tasks" class="space-y-2">
                        <!-- Задачи Выполнено будут загружены здесь -->
                    </div>
                    </div>
                </div>

            <!-- Загрузка -->
            <div id="loadingIndicator" class="flex justify-center items-center py-12">
                <div class="flex flex-col items-center">
                    <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                    <p class="mt-2 text-sm text-gray-500">Загрузка задач...</p>
                        </div>
                    </div>

            <!-- Пустое состояние -->
            <div id="emptyState" class="hidden text-center py-12">
                <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Нет задач</h3>
                <p class="text-gray-500 mb-6">Задачи пока не созданы или не найдены по выбранным фильтрам</p>
                    </div>
                </div>
            </div>
        </div>

<!-- Модальное окно создания/редактирования задачи -->
<div id="taskFormModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-6 border w-full max-w-md shadow-lg rounded-xl bg-white">
        <!-- Заголовок модального окна -->
        <div class="flex justify-between items-center pb-4">
            <h3 id="taskFormModalTitle" class="text-xl font-semibold text-gray-900">Новая задача</h3>
            <button id="closeTaskFormModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                        </button>
                    </div>

        <!-- Форма создания/редактирования задачи -->
        <form id="taskForm" class="space-y-4">
            <input type="hidden" id="taskId" name="task_id" value="">
            
            <!-- Название задачи -->
            <div>
                <input type="text" id="taskTitle" name="title" placeholder="Название задачи" required
                       class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-base">
                    </div>
            
            <!-- Описание -->
            <div>
                <textarea id="taskDescription" name="description" placeholder="Добавить описание..." rows="4"
                          class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white resize-none text-base"></textarea>
                </div>

            <!-- Приоритет -->
            <div>
                <select id="taskPriority" name="priority"
                        class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-base">
                    <option value="LOW">Низкий приоритет</option>
                    <option value="MEDIUM" selected>Средний приоритет</option>
                    <option value="HIGH">Высокий приоритет</option>
                </select>
                        </div>
            
            <!-- Поля действий -->
            <div class="flex gap-3">
                <!-- Исполнитель -->
                <div class="flex-1">
                    <select id="assignedUser" name="assigned_user"
                            class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-base">
                        <option value="">Назначить</option>
                        <!-- Опции будут загружены через JavaScript -->
                    </select>
                </div>

                <!-- Дата -->
                <div class="flex-1">
                    <input type="date" id="dueDate" name="due_date"
                           class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-base">
                </div>
            </div>
            
            <!-- Кнопка отправки -->
            <div class="flex justify-end">
                <button type="submit" id="taskFormSubmitBtn" class="px-6 py-3 bg-blue-600 text-white text-base font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    Создать задачу
                        </button>
                    </div>
        </form>
                    </div>
                </div>

<!-- Старое модальное окно создания задачи (для совместимости) -->
<div id="newTaskModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-6 border w-full max-w-md shadow-lg rounded-xl bg-white">
        <!-- Заголовок модального окна -->
        <div class="flex justify-between items-center pb-4">
            <h3 class="text-xl font-semibold text-gray-900">Новая задача</h3>
            <button id="closeNewTaskModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            </div>

        <!-- Форма создания задачи -->
        <form id="newTaskForm" class="space-y-4">
            <!-- Название задачи -->
            <div>
                <input type="text" id="oldTaskTitle" name="title" placeholder="Название задачи" required
                       class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-base">
        </div>

            <!-- Описание -->
            <div>
                <textarea id="oldTaskDescription" name="description" placeholder="Добавить описание..." rows="4"
                          class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white resize-none text-base"></textarea>
        </div>

            <!-- Поля действий -->
            <div class="flex gap-3">
                <!-- Исполнитель -->
                <div class="flex-1">
                    <select id="oldAssignedUser" name="assigned_user"
                            class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-base">
                        <option value="">Назначить</option>
                        <!-- Опции будут загружены через JavaScript -->
                    </select>
                </div>

                <!-- Дата -->
                <div class="flex-1">
                    <input type="date" id="oldDueDate" name="due_date"
                           class="w-full px-4 py-3 bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-base">
            </div>
        </div>

            <!-- Кнопка создания -->
            <div class="flex justify-end">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white text-base font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    Создать задачу
                </button>
                </div>
        </form>
    </div>
</div>

<!-- Модальное окно для деталей задачи -->
<div id="taskModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white m-4">
        <div class="mt-3">
            <!-- Заголовок модального окна -->
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Детали задачи</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Содержимое модального окна -->
            <div id="modalContent" class="mt-4">
                <!-- Контент будет загружен через JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Нижнее мобильное меню - показываем только на мобильных устройствах -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 hidden max-lg:block py-2">
    <div class="flex justify-between items-center px-2">
        <a href="{% url 'core:home' %}" class="flex-1 flex flex-col items-center text-gray-600 relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/home.svg' %}" alt="Home" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1 text-center whitespace-nowrap">Главная</span>
        </a>
        <a href="{% url 'core:tasks' %}" class="flex-1 flex flex-col items-center text-blue-600 relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/check-square.svg' %}" alt="Tasks" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1 text-center whitespace-nowrap">Задачи</span>
        </a>
        <a href="{% url 'core:map' %}" class="flex-1 flex flex-col items-center text-gray-600 relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/location.svg' %}" alt="Map" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1 text-center whitespace-nowrap">Карта</span>
        </a>
        <a href="{% url 'core:trucks' %}" class="flex-1 flex flex-col items-center text-gray-600 relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/truck.svg' %}" alt="Vehicles" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1 text-center whitespace-nowrap">Грузовики</span>
        </a>
        <a href="{% url 'core:employees' %}" class="flex-1 flex flex-col items-center text-gray-600 relative mx-1">
            <div class="icon-container w-8 h-8 flex items-center justify-center">
                <img src="{% static 'core/img/mobile/employee.svg' %}" alt="Employees" class="w-6 h-6">
            </div>
            <span class="text-xs text-[9px] mt-1 text-center whitespace-nowrap">Сотрудники</span>
        </a>
    </div>
</nav>

<!-- Плавающая кнопка создания задачи -->
{% if user.role == 'DIRECTOR' or user.role == 'SUPERADMIN' or user.role == 'DISPATCHER' or user.is_superuser %}
<button id="createTaskBtn" class="create-task-button">
    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
    </svg>
    Создать
</button>
{% endif %}

<script>
console.log('JavaScript загружен, версия: 2025-05-26-v2');

// Глобальные переменные
let allTasks = [];
let filteredTasks = [];

// Получаем данные пользователя
const currentUserId = JSON.parse(document.getElementById('user-id').textContent) || 0;
const currentUserRole = JSON.parse(document.getElementById('user-role').textContent) || '';
const currentUserName = JSON.parse(document.getElementById('user-name').textContent) || '';

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен, начинаем инициализацию');
    // Принудительно скрываем пустое состояние при загрузке
    hideEmptyState();
    loadTasks();
    setupEventListeners();
    loadNotificationCount();
});

// Настройка обработчиков событий
function setupEventListeners() {
    // Модальное окно деталей задачи
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('taskModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Новое модальное окно создания/редактирования задачи
    const floatingBtn = document.getElementById('createTaskBtn');
    const taskFormModal = document.getElementById('taskFormModal');
    const closeTaskFormModalBtn = document.getElementById('closeTaskFormModalBtn');
    const taskForm = document.getElementById('taskForm');
    
    if (floatingBtn) {
        floatingBtn.addEventListener('click', openNewTaskModal);
    }
    
    if (closeTaskFormModalBtn) {
        closeTaskFormModalBtn.addEventListener('click', closeTaskFormModal);
    }
    
    if (taskFormModal) {
        taskFormModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskFormModal();
            }
        });
    }
    
    if (taskForm) {
        taskForm.addEventListener('submit', handleTaskFormSubmit);
    }
    
    // Старое модальное окно создания задачи (для совместимости)
    const newTaskModal = document.getElementById('newTaskModal');
    const closeNewTaskModalBtn = document.getElementById('closeNewTaskModalBtn');
    const newTaskForm = document.getElementById('newTaskForm');
    
    if (closeNewTaskModalBtn) {
        closeNewTaskModalBtn.addEventListener('click', closeNewTaskModal);
    }
    
    if (newTaskModal) {
        newTaskModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeNewTaskModal();
            }
        });
    }
    
    if (newTaskForm) {
        newTaskForm.addEventListener('submit', handleNewTaskSubmit);
    }
}

// Загрузка задач
async function loadTasks() {
    try {
        console.log('Начинаем загрузку задач...');
        showLoading();
        
        // Проверяем доступность API
        try {
            const testResponse = await fetch('/api/tasks/?page=1&page_size=1');
            console.log('Тест API:', testResponse.status);
            if (!testResponse.ok) {
                throw new Error(`API недоступен: ${testResponse.status}`);
            }
        } catch (testError) {
            console.error('API недоступен:', testError);
            throw new Error('Сервер недоступен');
        }
        
        // Загружаем все задачи, обрабатывая пагинацию
        let allTasksData = [];
        let nextUrl = '/api/tasks/';
        
        while (nextUrl) {
            console.log('Загружаем страницу:', nextUrl);
            
            const response = await fetch(nextUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            console.log('Ответ получен:', response.status, response.statusText);
            
            if (!response.ok) {
                console.error('Ошибка ответа сервера:', response.status, response.statusText);
                throw new Error(`Ошибка загрузки задач: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Получены данные:', data);
            
            // Добавляем задачи с текущей страницы
            if (data.results && Array.isArray(data.results)) {
                allTasksData = allTasksData.concat(data.results);
                nextUrl = data.next; // URL следующей страницы или null
            } else if (Array.isArray(data)) {
                // Если нет пагинации, просто используем данные как есть
                allTasksData = data;
                nextUrl = null;
            } else {
                // Неожиданный формат данных
                console.error('Неожиданный формат данных:', data);
                nextUrl = null;
            }
        }
        
        allTasks = allTasksData;
        filteredTasks = [...allTasks];
        
        console.log('Загружено задач:', allTasks.length);
        
        updateTaskCounts();
        renderTasksByGroups();
        hideLoading();
        
    } catch (error) {
        console.error('Ошибка загрузки задач:', error);
        console.error('Детали ошибки:', error.message);
        hideLoading();
        
        // Показываем сообщение об ошибке пользователю
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-center py-12';
        errorMessage.innerHTML = `
            <div class="mx-auto w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-4">
                <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Ошибка загрузки</h3>
            <p class="text-gray-500 mb-6">Не удалось загрузить задачи. Проверьте подключение к интернету.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="loadTasks()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Попробовать снова</button>
                <button onclick="location.reload(true)" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Обновить страницу</button>
            </div>
        `;
        
        // Заменяем пустое состояние на сообщение об ошибке
        const emptyState = document.getElementById('emptyState');
        emptyState.innerHTML = errorMessage.innerHTML;
        emptyState.classList.remove('hidden');
    }
}

// Отображение задач по группам
function renderTasksByGroups() {
    console.log('Отображаем задачи, всего:', filteredTasks.length);
    
    if (filteredTasks.length === 0) {
        console.log('Нет задач для отображения');
        showEmptyState();
        clearAllGroups();
        return;
    }
    
    hideEmptyState();
    
    // Группируем задачи по статусам (убираем APPROVED)
    const groupedTasks = {
        'NEW': filteredTasks.filter(task => task.status === 'NEW'),
        'IN_PROGRESS': filteredTasks.filter(task => task.status === 'IN_PROGRESS'),
        'COMPLETED': filteredTasks.filter(task => task.status === 'COMPLETED')
    };
    
    // Отображаем задачи в каждой группе (убираем approved-tasks)
    renderTaskGroup('todo-tasks', groupedTasks.NEW);
    renderTaskGroup('progress-tasks', groupedTasks.IN_PROGRESS);
    renderTaskGroup('done-tasks', groupedTasks.COMPLETED);
    
    // Обновляем счетчики (убираем approved-count)
    document.getElementById('todo-count').textContent = groupedTasks.NEW.length;
    document.getElementById('progress-count').textContent = groupedTasks.IN_PROGRESS.length;
    document.getElementById('done-count').textContent = groupedTasks.COMPLETED.length;
}

// Отображение задач в конкретной группе
function renderTaskGroup(containerId, tasks) {
    const container = document.getElementById(containerId);
    if (tasks.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">Нет задач</div>';
        return;
    }
    container.innerHTML = tasks.map(task => {
        // Чекпоинт с обработчиком клика
        const isCompleted = task.status === 'COMPLETED';
        const nextStatus = task.status === 'NEW' ? 'IN_PROGRESS' : task.status === 'IN_PROGRESS' ? 'COMPLETED' : null;
        const checkPoint = `
            <div class="check-point flex-shrink-0 mr-4 cursor-pointer" onclick="event.stopPropagation();${nextStatus ? `changeTaskStatus(${task.id}, '${nextStatus}')` : ''}">
                <div class="w-5 h-5 rounded-full flex items-center justify-center ${isCompleted ? 'border-2 border-gray-300 bg-white' : 'border-2 border-gray-300 bg-white'}" style="${isCompleted ? 'background-color: #267BD9 !important; border-color: #267BD9 !important;' : ''}">
                    ${isCompleted ? `<svg class="w-3 h-3" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>` : ''}
                </div>
            </div>
        `;
        // Приоритет
        const priorityBadge = getPriorityBadge(task.priority);
        // Дата
        const dateBadge = task.due_date ? 
            `<span class='flex items-center gap-1 text-xs text-gray-400'>
                <svg class='w-4 h-4' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'>
                    <rect x='3' y='4' width='18' height='18' rx='2' fill='none'/>
                    <path d='M16 2v4M8 2v4M3 10h18'/>
                </svg>
                <span>${formatDate(task.due_date)}</span>
            </span>` : 
            `<span class='flex items-center gap-1 text-xs text-gray-400'>
                <svg class='w-4 h-4' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'>
                    <rect x='3' y='4' width='18' height='18' rx='2' fill='none'/>
                    <path d='M16 2v4M8 2v4M3 10h18'/>
                </svg>
                <span>Без срока</span>
            </span>`;
        // Аватары (заглушка: один или несколько)
        let avatars = '';
        if (Array.isArray(task.assigned_users_details)) {
            avatars = `<div class='flex -space-x-2 ml-4'>` +
                task.assigned_users_details.slice(0,3).map(u =>
                    u.photo ? `<img src='${u.photo}' class='avatar-img' title='${u.full_name}'/>`
                    : `<div class='avatar-img bg-gray-200 text-gray-600' title='${u.full_name}'>${u.initials || 'U'}</div>`
                ).join('') +
                (task.assigned_users_details.length > 3 ? `<div class='avatar-img bg-gray-300 text-xs'>+${task.assigned_users_details.length-3}</div>` : '') +
                `</div>`;
        } else if (task.assigned_user_details) {
            avatars = `<div class='flex ml-4'><div class='avatar-img bg-gray-200 text-gray-600'>${task.assigned_user_details.first_name ? task.assigned_user_details.first_name.charAt(0) : 'U'}</div></div>`;
        }
        // Кнопки
        const editButton = canEditTask(task) ? `<button onclick=\"event.stopPropagation(); editTask(${task.id})\" class=\"action-btn edit-btn\"><svg class=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><path d=\"M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z\"></path></svg></button>` : '';
        const moreButton = `<button onclick=\"event.stopPropagation(); openTaskModal(${task.id})\" class=\"action-btn more-btn\"><svg class=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><circle cx=\"10\" cy=\"4\" r=\"2\"/><circle cx=\"10\" cy=\"10\" r=\"2\"/><circle cx=\"10\" cy=\"16\" r=\"2\"/></svg></button>`;
        // Класс для завершённых
        const titleClass = isCompleted ? 'task-title completed' : 'task-title';
        return `
        <div class=\"task-row group\" onclick=\"openTaskModal(${task.id})\">
            ${checkPoint}
            <div class=\"task-content\">
                <span class=\"${titleClass}\">${task.title}</span>
                <div class=\"task-meta\">
                    <div class=\"flex items-center gap-2\">
                        ${priorityBadge}
                    </div>
                    <div class=\"flex items-center gap-2\">
                        ${dateBadge}
                        ${avatars}
                    </div>
                </div>
            </div>
            <div class=\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity task-actions\">
                ${editButton}
                ${moreButton}
            </div>
        </div>`;
    }).join('');
}

// Очистка всех групп
function clearAllGroups() {
    ['todo-tasks', 'progress-tasks', 'done-tasks'].forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">Нет задач</div>';
        }
    });
}

// Получение бейджа статуса
function getStatusBadge(status) {
    const badges = {
        'NEW': '<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-gray-100 text-gray-800">Новая</span>',
        'IN_PROGRESS': '<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-orange-100 text-orange-800">В работе</span>',
        'COMPLETED': '<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-green-100 text-green-800">Завершена</span>',
        'CANCELLED': '<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-red-100 text-red-800">Отменена</span>'
    };
    return badges[status] || '';
}

// Получение бейджа приоритета
function getPriorityBadge(priority) {
    const badges = {
        'LOW': '<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-slate-100 text-slate-600">Низкий</span>',
        'MEDIUM': '<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-amber-100 text-amber-600">Средний</span>',
        'HIGH': '<span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-rose-100 text-rose-600">Высокий</span>'
    };
    return badges[priority] || '';
}

// Форматирование даты
function formatDate(dateString) {
    const date = new Date(dateString);
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    // Проверяем, если дата сегодня
    if (date.toDateString() === today.toDateString()) {
        return 'Сегодня';
    }
    
    // Проверяем, если дата завтра
    if (date.toDateString() === tomorrow.toDateString()) {
        return 'Завтра';
    }
    
    // Для остальных дат показываем день и месяц
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: 'short'
    });
}

// Проверка прав на редактирование
function canEditTask(task) {
    return ['DIRECTOR', 'SUPERADMIN', 'DISPATCHER'].includes(currentUserRole) ||
           task.created_by === currentUserId ||
           task.assigned_to === currentUserId;
}

// Открытие модального окна задачи
function openTaskModal(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    
    // Исполнитель
    const assignedUserHtml = task.assigned_user_details ? `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Исполнитель</label>
            <p class="text-gray-900">${task.assigned_user_details.full_name || task.assigned_user_details.username || 'Не указан'}</p>
        </div>
    ` : task.assigned_to ? `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Исполнитель</label>
            <p class="text-gray-900">ID: ${task.assigned_to}</p>
        </div>
    ` : `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Исполнитель</label>
            <p class="text-gray-500">Не назначен</p>
        </div>
    `;
    
    // Транспорт
    const vehicleHtml = task.vehicle_details ? `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Транспорт</label>
            <p class="text-gray-900">${task.vehicle_details.brand} ${task.vehicle_details.model} (${task.vehicle_details.number})</p>
        </div>
    ` : '';
    
    // Создатель
    const createdByHtml = task.created_by_details ? `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Создал</label>
            <p class="text-gray-900">${task.created_by_details.full_name || task.created_by_details.username || 'Не указан'}</p>
        </div>
    ` : task.created_by ? `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Создал</label>
            <p class="text-gray-900">ID: ${task.created_by}</p>
        </div>
    ` : `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Создал</label>
            <p class="text-gray-500">Не указан</p>
        </div>
    `;
    
    // Кнопки действий
    const editButtonHtml = canEditTask(task) ? `
        <button onclick="openEditTaskModal(${task.id})" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Редактировать
        </button>
    ` : '';
    
    const statusButtonHtml = '';
    
    const deleteButtonHtml = canEditTask(task) ? `
        <button onclick="deleteTask(${task.id})" class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-lg text-red-700 bg-white hover:bg-red-50">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Удалить
        </button>
    ` : '';
    
    document.getElementById('modalTitle').textContent = task.title;
    document.getElementById('modalContent').innerHTML = `
        <div class="space-y-4 task-modal-content">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                <p class="text-gray-900">${task.description || 'Описание не указано'}</p>
            </div>
            
            <!-- Компактная сетка для мобильных -->
            <div class="task-details-grid">
                <div class="task-detail-item">
                    <label class="task-detail-label">Статус</label>
                    <div class="badge-wrapper">${getStatusBadge(task.status)}</div>
                </div>
                
                <div class="task-detail-item">
                    <label class="task-detail-label">Приоритет</label>
                    <div class="badge-wrapper">${getPriorityBadge(task.priority)}</div>
                </div>
                
                <div class="task-detail-item">
                    <label class="task-detail-label">Срок выполнения</label>
                    <p class="task-detail-text">${task.due_date ? formatDate(task.due_date) : 'Не указан'}</p>
                </div>
                
                <div class="task-detail-item">
                    <label class="task-detail-label">Дата создания</label>
                    <p class="task-detail-text">${task.created_at ? formatDate(task.created_at) : 'Не указана'}</p>
                </div>
                
                <div class="task-detail-item task-detail-full">
                    <label class="task-detail-label">Исполнитель</label>
                    <p class="task-detail-text">${task.assigned_user_details ? task.assigned_user_details.full_name || task.assigned_user_details.username || 'Не указан' : 'Не назначен'}</p>
                </div>
                
                <div class="task-detail-item task-detail-full">
                    <label class="task-detail-label">Создал</label>
                    <p class="task-detail-text">${task.created_by_details ? task.created_by_details.full_name || task.created_by_details.username || 'Не указан' : 'Не указан'}</p>
                </div>
                
                ${task.vehicle_details ? `
                <div class="task-detail-item task-detail-full">
                    <label class="task-detail-label">Транспорт</label>
                    <p class="task-detail-text">${task.vehicle_details.brand} ${task.vehicle_details.model} (${task.vehicle_details.number})</p>
                </div>
                ` : ''}
            </div>
            
            <div class="task-modal-actions">
                <div class="task-modal-actions-left">
                    ${deleteButtonHtml}
                </div>
                <div class="task-modal-actions-right">
                    ${editButtonHtml}
                    ${statusButtonHtml}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('taskModal').classList.remove('hidden');
}

// Закрытие модального окна
function closeModal() {
    document.getElementById('taskModal').classList.add('hidden');
}

// Изменение статуса задачи
async function changeTaskStatus(taskId, newStatus) {
    try {
        const response = await fetch(`/api/tasks/${taskId}/change_status/`, {
            method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            closeModal();
            loadTasks(); // Перезагружаем задачи
            showNotification('Статус задачи успешно изменен', 'success');
            } else {
            alert('Ошибка при изменении статуса задачи');
            }
        } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при изменении статуса задачи');
    }
}

// Удаление задачи
async function deleteTask(taskId) {
    if (!confirm('Вы уверены, что хотите удалить эту задачу? Это действие нельзя отменить.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            closeModal();
            loadTasks(); // Перезагружаем задачи
            showNotification('Задача успешно удалена', 'success');
        } else {
            const errorData = await response.json();
            alert('Ошибка при удалении задачи: ' + (errorData.detail || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при удалении задачи');
    }
}

// Функция редактирования задачи
function editTask(taskId) {
    openEditTaskModal(taskId);
}

// Проверка прав на изменение статуса
function canChangeStatus(task) {
    return ['DIRECTOR', 'SUPERADMIN'].includes(currentUserRole) ||
           task.assigned_to === currentUserId;
}

// Показать индикатор загрузки
function showLoading() {
    document.getElementById('loadingIndicator').classList.remove('hidden');
    document.getElementById('emptyState').classList.add('hidden');
}

// Скрыть индикатор загрузки
function hideLoading() {
    document.getElementById('loadingIndicator').classList.add('hidden');
}

// Показать пустое состояние
function showEmptyState() {
    document.getElementById('emptyState').classList.remove('hidden');
    hideLoading();
}

// Скрыть пустое состояние
function hideEmptyState() {
    document.getElementById('emptyState').classList.add('hidden');
}

// Загрузка количества уведомлений
async function loadNotificationCount() {
    try {
        const response = await fetch('/api/notifications/unread_count/');
        if (response.ok) {
            const data = await response.json();
            const badge = document.getElementById('notif-badge');
            if (data.count > 0) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
    } catch (error) {
        console.error('Ошибка загрузки уведомлений:', error);
    }
}

// Обновление счетчиков задач
function updateTaskCounts() {
    // Эта функция теперь вызывается в renderTasksByGroups()
    // Оставляем для совместимости
}

// Загрузка списка сотрудников для новой формы
async function loadEmployeesForTaskForm() {
    try {
        const response = await fetch('/api/employees/', {
            method: 'GET',
                headers: {
                'Accept': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            credentials: 'same-origin'
            });
            
            if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
        const employees = data.results || data;
        
        // Получаем select элемент
        const selectElement = document.getElementById('assignedUser');
        
        // Сохраняем текущее значение
        const currentValue = selectElement.value;
        
        // Очищаем и добавляем опцию по умолчанию
        selectElement.innerHTML = '<option value="">Назначить</option>';
        
        // Добавляем сотрудников
        employees.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.id;
            const fullName = `${employee.first_name || ''} ${employee.last_name || ''}`.trim();
            option.textContent = fullName || employee.username || `Сотрудник #${employee.id}`;
            selectElement.appendChild(option);
        });
        
        // Восстанавливаем значение
        if (currentValue) {
            selectElement.value = currentValue;
        }
        
        } catch (error) {
        console.error('Ошибка загрузки сотрудников:', error);
    }
}

// Загрузка списка сотрудников для старой формы
async function loadEmployees() {
    try {
        const response = await fetch('/api/employees/', {
            method: 'GET',
                headers: {
                'Accept': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            credentials: 'same-origin'
            });
            
            if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
        const employees = data.results || data;
        
        // Получаем select элемент
        const selectElement = document.getElementById('oldAssignedUser');
        
        // Очищаем и добавляем опцию по умолчанию
        selectElement.innerHTML = '<option value="">Назначить</option>';
        
        // Добавляем сотрудников
        employees.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.id;
            const fullName = `${employee.first_name || ''} ${employee.last_name || ''}`.trim();
            option.textContent = fullName || employee.username || `Сотрудник #${employee.id}`;
            selectElement.appendChild(option);
        });
        
        } catch (error) {
        console.error('Ошибка загрузки сотрудников:', error);
    }
}

// Открытие модального окна создания задачи
function openNewTaskModal() {
    // Используем новое модальное окно
    document.getElementById('taskFormModalTitle').textContent = 'Новая задача';
    document.getElementById('taskFormSubmitBtn').textContent = 'Создать задачу';
    document.getElementById('taskId').value = '';
    
    // Очищаем форму
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskPriority').value = 'MEDIUM';
    document.getElementById('assignedUser').value = '';
    document.getElementById('dueDate').value = '';
    
    document.getElementById('taskFormModal').classList.remove('hidden');
    document.getElementById('taskTitle').focus();
    // Загружаем список сотрудников при открытии модального окна
    loadEmployeesForTaskForm();
}

// Открытие модального окна редактирования задачи
function openEditTaskModal(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    
    // Закрываем модальное окно деталей
    closeModal();
    
    // Настраиваем заголовок и кнопку
    document.getElementById('taskFormModalTitle').textContent = 'Редактировать задачу';
    document.getElementById('taskFormSubmitBtn').textContent = 'Сохранить изменения';
    document.getElementById('taskId').value = task.id;
    
    // Заполняем форму данными задачи
    document.getElementById('taskTitle').value = task.title || '';
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskPriority').value = task.priority || 'MEDIUM';
    document.getElementById('assignedUser').value = task.assigned_to || '';
    
    // Форматируем дату для input[type="date"]
    if (task.due_date) {
        const date = new Date(task.due_date);
        const formattedDate = date.toISOString().split('T')[0];
        document.getElementById('dueDate').value = formattedDate;
    } else {
        document.getElementById('dueDate').value = '';
    }
    
    document.getElementById('taskFormModal').classList.remove('hidden');
    document.getElementById('taskTitle').focus();
    // Загружаем список сотрудников при открытии модального окна
    loadEmployeesForTaskForm();
}

// Закрытие нового модального окна создания/редактирования задачи
function closeTaskFormModal() {
    document.getElementById('taskFormModal').classList.add('hidden');
    document.getElementById('taskForm').reset();
}

// Закрытие старого модального окна создания задачи
function closeNewTaskModal() {
    document.getElementById('newTaskModal').classList.add('hidden');
    document.getElementById('newTaskForm').reset();
}

// Обработка отправки новой формы создания/редактирования задачи
async function handleTaskFormSubmit(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('taskId').value;
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const priority = document.getElementById('taskPriority').value;
    const assignedUser = document.getElementById('assignedUser').value.trim();
    const dueDate = document.getElementById('dueDate').value;
    
    if (!title) {
        alert('Введите название задачи');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        priority: priority,
        status: 'NEW'
    };
    
    // Добавляем исполнителя если указан
    if (assignedUser) {
        if (!isNaN(assignedUser)) {
            taskData.assigned_to = parseInt(assignedUser);
        }
    }
    
    // Добавляем дату если выбрана
    if (dueDate) {
        taskData.due_date = dueDate + 'T12:00:00';
    }
    
    try {
        let url = '/api/tasks/';
        let method = 'POST';
        
        // Если редактируем существующую задачу
        if (taskId) {
            url = `/api/tasks/${taskId}/`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(taskData)
        });
        
        if (response.ok) {
            closeTaskFormModal();
            loadTasks(); // Перезагружаем задачи
            // Показываем уведомление об успехе
            const message = taskId ? 'Задача успешно обновлена' : 'Задача успешно создана';
            showNotification(message, 'success');
        } else {
            const errorData = await response.json();
            alert('Ошибка при сохранении задачи: ' + (errorData.detail || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при сохранении задачи');
    }
}

// Обработка отправки старой формы создания задачи
async function handleNewTaskSubmit(e) {
        e.preventDefault();
    
    const title = document.getElementById('oldTaskTitle').value.trim();
    const description = document.getElementById('oldTaskDescription').value.trim();
    const assignedUser = document.getElementById('oldAssignedUser').value.trim();
    const dueDate = document.getElementById('oldDueDate').value;
    
    if (!title) {
        alert('Введите название задачи');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        status: 'NEW',
        priority: 'MEDIUM'
    };
    
    // Добавляем исполнителя если указан (пока как текст, можно расширить для поиска пользователей)
    if (assignedUser) {
        // Если это число, считаем что это ID пользователя
        if (!isNaN(assignedUser)) {
            taskData.assigned_to = parseInt(assignedUser);
        }
    }
    
    // Добавляем дату если выбрана
    if (dueDate) {
        taskData.due_date = dueDate + 'T12:00:00';
    }
    
    try {
        const response = await fetch('/api/tasks/', {
            method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(taskData)
        });
        
        if (response.ok) {
            closeNewTaskModal();
            loadTasks(); // Перезагружаем задачи
            // Показываем уведомление об успехе
            showNotification('Задача успешно создана', 'success');
        } else {
            const errorData = await response.json();
            alert('Ошибка при создании задачи: ' + (errorData.detail || 'Неизвестная ошибка'));
            }
        } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при создании задачи');
    }
}

// Показ уведомлений
function showNotification(message, type = 'info') {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Автоматически убираем через 3 секунды
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>

<style>
.task-row {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0px 2px 4px -1px rgba(13,13,18,0.06);
    outline: 1px solid rgb(229 231 235);
    outline-offset: -1px;
    padding: 0.5rem 1.25rem;
    margin-bottom: 0.5rem;
    min-height: 56px;
    transition: box-shadow 0.15s, background 0.15s, outline-color 0.15s;
    position: relative;
    animation: taskCardFadeIn 0.2s ease-out;
}

.task-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.task-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto;
}

.task-actions {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}
.task-row:hover {
    box-shadow: 0px 4px 8px -2px rgba(13,13,18,0.10);
    background: #f9fafb;
    outline-color: rgb(209 213 219);
}
.check-point {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.check-point > div {
    width: 20px;
    height: 20px;
    transition: all 0.2s ease-in-out;
}

.check-point:hover > div {
    transform: scale(1.05);
}

.check-point:hover > div.border-gray-300 {
    border-color: #9ca3af;
}

.check-point svg {
    display: block;
}
.task-title {
    font-size: 1rem;
    font-weight: 500;
    color: #18181b;
    margin-right: 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.task-title.completed {
    color: #a3a3a3;
    text-decoration: line-through;
}
.category-badge {
    display: inline-block;
    font-size: 0.85em;
    font-weight: 500;
    border-radius: 6px;
    padding: 0.15em 0.7em;
    margin-left: 0.25em;
    margin-right: 0.1em;
    background: #f1f5f9;
}
.avatar-img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.95em;
    font-weight: 600;
    border: 2px solid #fff;
    box-shadow: 0 1px 2px 0 rgba(16,30,54,0.04);
    background: #e5e7eb;
    text-align: center;
}
.action-btn {
    background: none;
    border: none;
    padding: 0.25rem;
    border-radius: 6px;
    cursor: pointer;
    color: #a3a3a3;
    transition: background 0.15s, color 0.15s;
}
.action-btn:hover {
    background: #e0e7ef;
    color: #6366f1;
}
.more-btn {
    margin-left: 0.1rem;
}
.group:hover .action-btn {
    opacity: 1;
}
.group .action-btn {
    opacity: 0;
    transition: opacity 0.15s;
}
.group:hover .action-btn {
    opacity: 1;
}

/* Стили для кнопки создания */
.create-task-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 24px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    min-width: 140px;
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 50;
}

.create-task-button:hover {
    background: #1d4ed8;
    box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    transform: translateY(-1px);
}

.create-task-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

/* Стили для кнопок в попапе */
.action-option-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    border: 1px solid #e5e7eb;
    background: white;
    color: #6b7280;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    text-align: center;
}

.action-option-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    color: #374151;
}

.action-option-btn svg {
    flex-shrink: 0;
}

.action-option-btn span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Мобильная адаптация */
@media (max-width: 1024px) {
    .ml-64 {
        margin-left: 0 !important;
    }
    
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
    }
    
    .sidebar.open {
        transform: translateX(0);
    }
    
    .main-content {
        padding-bottom: 120px !important;
    }
}

@media (max-width: 768px) {
    .px-8 {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }
    
    .py-6 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
    }
    
    .text-2xl {
        font-size: 1.25rem !important;
    }
    
    /* Мобильная адаптация карточек задач */
    .task-row {
        display: flex !important;
        align-items: center !important;
        background: #fff !important;
        border-radius: 16px !important;
        box-shadow: 0px 2px 4px -1px rgba(13,13,18,0.06) !important;
        outline: 1px solid rgb(229 231 235) !important;
        outline-offset: -1px !important;
        padding: 1rem !important;
        margin-bottom: 0.5rem !important;
        min-height: 60px !important;
        transition: box-shadow 0.15s, background 0.15s, outline-color 0.15s !important;
        position: relative !important;
    }
    
    .task-row:hover {
        box-shadow: 0px 4px 8px -2px rgba(13,13,18,0.10) !important;
        background: #f9fafb !important;
        outline-color: rgb(209 213 219) !important;
    }
    
    .check-point {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-right: 1rem !important;
        flex-shrink: 0 !important;
    }
    
    .check-point > div {
        width: 20px !important;
        height: 20px !important;
    }
    
    .check-point svg {
        width: 12px !important;
        height: 12px !important;
    }
    
    .task-content {
        flex: 1 !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        min-width: 0 !important;
    }
    
    .task-title {
        font-size: 1rem !important;
        font-weight: 500 !important;
        color: #1f2937 !important;
        margin-right: 0.5rem !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        flex: 1 !important;
    }
    
    .task-title.completed {
        color: #9ca3af !important;
        text-decoration: line-through !important;
    }
    
    .task-meta {
        display: flex !important;
        flex-direction: column !important;
        align-items: flex-end !important;
        gap: 0.25rem !important;
        margin-left: auto !important;
        flex-shrink: 0 !important;
    }
    
    /* Приоритет скрываем на мобильных для чистоты */
    .task-meta .flex.items-center.gap-2 > span:first-child {
        display: none !important;
    }
    
    /* Показываем дату с иконкой */
    .task-meta .flex.items-center.gap-1.text-xs.text-gray-400 {
        display: flex !important;
        align-items: center !important;
        color: #9ca3af !important;
        font-size: 0.75rem !important;
    }
    
    .task-meta .flex.items-center.gap-1.text-xs.text-gray-400 svg {
        width: 14px !important;
        height: 14px !important;
        flex-shrink: 0 !important;
    }
    
    .task-meta .flex.items-center.gap-1.text-xs.text-gray-400 span {
        display: inline !important;
        white-space: nowrap !important;
    }
    
    /* Аватары скрываем на мобильных */
    .task-meta .flex.-space-x-2 {
        display: none !important;
    }
    
    /* Стили для второго блока в task-meta */
    .task-meta > div:last-child {
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }
    
    /* Кнопки действий скрываем на мобильных */
    .task-actions {
        display: none !important;
    }
    
    /* Заголовки групп */
    .space-y-6 > div > .flex.items-center.justify-between.mb-4 h3 {
        font-size: 1.1rem !important;
        font-weight: 600 !important;
    }
    
    .space-y-6 > div > .flex.items-center.justify-between.mb-4 span {
        font-size: 0.875rem !important;
        padding: 0.25rem 0.5rem !important;
        font-weight: 500 !important;
    }
    
    /* Мобильная адаптация кнопки создания */
    .create-task-button {
        width: calc(100% - 2rem);
        max-width: none;
        margin: 0 1rem;
        padding: 16px 24px;
        font-size: 18px;
        position: fixed;
        bottom: 90px;
        left: 0;
        right: 0;
        z-index: 40;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        min-width: auto;
        animation: none !important;
        opacity: 1 !important;
        transform: none !important;
        transition: none !important;
    }
    
    /* Отключаем hover и active эффекты для мобильной кнопки */
    .create-task-button:hover {
        background: #2563eb !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3) !important;
        transform: none !important;
    }
    
    .create-task-button:active {
        background: #2563eb !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3) !important;
        transform: none !important;
    }
    
    /* Мобильная адаптация попапов */
    #taskFormModal .relative {
        top: 10px !important;
        margin: 0 1rem !important;
        max-width: none !important;
        width: calc(100% - 2rem) !important;
    }
    
    #newTaskModal .relative {
        top: 10px !important;
        margin: 0 1rem !important;
        max-width: none !important;
        width: calc(100% - 2rem) !important;
    }
    
    #taskModal {
        padding: 1rem !important;
    }
    
    #taskModal .relative {
        margin: 0 !important;
        max-width: none !important;
        width: 100% !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
    }
    
    .action-option-btn {
        padding: 14px 12px;
        font-size: 13px;
    }
    
    .action-option-btn span {
        font-size: 12px;
    }
    
    /* Пустое состояние для групп - только для текста "Нет задач" */
    .space-y-2 > div:only-child:not(.task-row) {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: #f9fafb !important;
        border: 2px dashed #d1d5db !important;
        border-radius: 12px !important;
        color: #6b7280 !important;
        font-size: 0.875rem !important;
        text-align: center !important;
        min-height: 80px !important;
        padding: 1rem !important;
    }
}

/* Стили для мобильного меню */
@media (max-width: 1024px) {
    .max-lg\:block {
        display: block !important;
    }
}

@media (max-width: 1100px) {
    body nav.fixed.bottom-0 {
        height: 70px !important;
        padding-top: 10px !important;
        box-shadow: none !important;
        z-index: 999 !important;
        background-color: #fff !important;
        border-top: 1px solid #E5E7EB !important;
        animation: none !important;
        opacity: 1 !important;
        transform: none !important;
        transition: none !important;
    }
}

/* Анимации и переходы */
.task-item {
    transition: all 0.2s ease-in-out;
}

button:hover {
    transition: all 0.2s ease-in-out;
}

/* Стили для чекпоинтов */
.task-item .w-5.h-5.rounded-full {
    transition: all 0.2s ease-in-out;
}

.task-item:hover .w-5.h-5.rounded-full.border-gray-300 {
    border-color: #9ca3af;
}

/* Скрыть атрибуцию Leaflet/OpenStreetMap */
.leaflet-control-attribution { display: none !important; }

/* Быстрая анимация появления страницы */
.main-content {
    animation: pageFadeIn 0.3s ease-out;
}

/* Исключаем нижнее меню и кнопку создания из анимации страницы */
nav.fixed.bottom-0,
.create-task-button {
    animation: none !important;
}

@keyframes pageFadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Анимация появления карточек задач - исключаем кнопки */
.task-row {
    animation: taskCardFadeIn 0.2s ease-out;
}

@keyframes taskCardFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

    #taskModal .relative {
        margin: 0 !important;
        max-width: none !important;
        width: 100% !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
    }
    
    /* Компактные стили для модального окна задач на мобильных */
    .task-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .task-detail-item {
        display: flex;
        flex-direction: column;
        min-height: auto;
    }
    
    .task-detail-full {
        grid-column: span 2;
    }
    
    .task-detail-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 2px;
        line-height: 1.2;
    }
    
    .task-detail-text {
        font-size: 0.875rem;
        color: #1f2937;
        margin: 0;
        line-height: 1.3;
    }
    
    .task-modal-content .space-y-4 > * + * {
        margin-top: 12px !important;
    }
    
    .task-modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        gap: 8px;
    }
    
    .task-modal-actions-left,
    .task-modal-actions-right {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .task-modal-actions-right {
        justify-content: flex-end;
    }
    
    /* Компактные кнопки в модальном окне */
    .task-modal-actions button {
        padding: 8px 12px !important;
        font-size: 0.875rem !important;
        white-space: nowrap;
    }
    
    .task-modal-actions button svg {
        width: 14px !important;
        height: 14px !important;
    }
}

/* Десктопные стили для модального окна */
@media (min-width: 769px) {
    #taskModal .relative {
        max-width: 800px !important;
        width: auto !important;
        margin: 0 auto !important;
    }
    
    #taskModal {
        padding: 0 !important;
        z-index: 9999 !important;
    }
    
    .task-details-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 20px !important;
        margin-bottom: 24px !important;
    }
    
    .task-detail-item {
        display: flex !important;
        flex-direction: column !important;
        min-height: auto !important;
    }
    
    .task-detail-full {
        grid-column: span 2 !important;
    }
    
    .task-detail-label {
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        color: #6b7280 !important;
        margin-bottom: 4px !important;
        line-height: 1.2 !important;
    }
    
    .task-detail-text {
        font-size: 1rem !important;
        color: #1f2937 !important;
        margin: 0 !important;
        line-height: 1.4 !important;
    }
    
    .task-modal-content .space-y-4 > * + * {
        margin-top: 1.5rem !important;
    }
    
    .task-modal-actions {
        padding-top: 1.5rem !important;
        gap: 1rem !important;
    }
    
    .task-modal-actions button {
        padding: 0.75rem 1.25rem !important;
        font-size: 0.875rem !important;
    }
    
    .task-modal-actions button svg {
        width: 1rem !important;
        height: 1rem !important;
        margin-right: 0.5rem !important;
    }
    
    /* Исправление бейджей на десктопе - не растягиваем */
    .task-detail-item span[class*="inline-flex"] {
        align-self: flex-start !important;
        width: auto !important;
        max-width: fit-content !important;
        flex: none !important;
        flex-shrink: 0 !important;
        display: inline-flex !important;
    }
    
    /* Дополнительная защита от растягивания */
    .task-details-grid .task-detail-item > span[class*="bg-"] {
        width: auto !important;
        flex: none !important;
        display: inline-flex !important;
        align-self: flex-start !important;
    }
    
    /* Обертка для бейджей */
    .badge-wrapper {
        display: flex !important;
        align-items: flex-start !important;
        width: auto !important;
    }
    
    .badge-wrapper span {
        flex: none !important;
        width: auto !important;
        display: inline-flex !important;
    }
}

/* Мобильные стили для модального окна */
@media (max-width: 768px) {
    #taskModal {
        z-index: 9999 !important;
        padding: 1rem !important;
    }
    
    #taskModal .relative {
        margin: 0 !important;
        max-width: none !important;
        width: 100% !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
    }
    
    .task-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .task-detail-item {
        display: flex;
        flex-direction: column;
        min-height: auto;
    }
    
    .task-detail-full {
        grid-column: span 2;
    }
    
    .task-detail-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 2px;
        line-height: 1.2;
    }
    
    .task-detail-text {
        font-size: 0.875rem;
        color: #1f2937;
        margin: 0;
        line-height: 1.3;
    }
    
    .task-modal-content .space-y-4 > * + * {
        margin-top: 12px !important;
    }
    
    .task-modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        gap: 8px;
    }
    
    .task-modal-actions-left,
    .task-modal-actions-right {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .task-modal-actions-right {
        justify-content: flex-end;
    }
    
    .task-modal-actions button {
        padding: 8px 12px !important;
        font-size: 0.875rem !important;
        white-space: nowrap;
    }
    
    .task-modal-actions button svg {
        width: 14px !important;
        height: 14px !important;
    }
}

/* Исправление отступов у бейджей статуса и приоритета */
.task-detail-item span[class*="inline-flex"] {
    padding: 0.25rem 0.625rem !important; /* py-1 px-2.5 но равномерно */
    white-space: nowrap !important;
}

/* Общие стили для модального окна */
#taskModal {
    z-index: 9999 !important;
}

/* Исправление отступов у бейджей статуса и приоритета */
.task-detail-item span[class*="inline-flex"] {
    padding: 0.25rem 0.625rem !important;
    white-space: nowrap !important;
    width: auto !important;
    display: inline-flex !important;
}

/* Десктопные стили для модального окна */
@media (min-width: 769px) {
    #taskModal .relative {
        max-width: 800px !important;
        width: auto !important;
        margin: 0 auto !important;
    }
    
    #taskModal {
        padding: 0 !important;
        z-index: 9999 !important;
    }
    
    .task-details-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 20px !important;
        margin-bottom: 24px !important;
    }
    
    .task-detail-item {
        display: flex !important;
        flex-direction: column !important;
        min-height: auto !important;
    }
    
    .task-detail-full {
        grid-column: span 2 !important;
    }
    
    .task-detail-label {
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        color: #6b7280 !important;
        margin-bottom: 4px !important;
        line-height: 1.2 !important;
    }
    
    .task-detail-text {
        font-size: 1rem !important;
        color: #1f2937 !important;
        margin: 0 !important;
        line-height: 1.4 !important;
    }
    
    .task-modal-content .space-y-4 > * + * {
        margin-top: 1.5rem !important;
    }
    
    .task-modal-actions {
        padding-top: 1.5rem !important;
        gap: 1rem !important;
    }
    
    .task-modal-actions button {
        padding: 0.75rem 1.25rem !important;
        font-size: 0.875rem !important;
    }
    
    .task-modal-actions button svg {
        width: 1rem !important;
        height: 1rem !important;
        margin-right: 0.5rem !important;
    }
}
</style>
{% endblock %} 