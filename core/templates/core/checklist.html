{% extends 'core/base.html' %}
{% load static %}

{% block title %}Чек-листы поездок | BARLAU.KZ{% endblock %}

{% block content %}
<div class="w-full flex">
    <!-- Боковая панель -->
    <div class="w-64 h-screen bg-white border-r border-zinc-200 flex flex-col justify-start items-start fixed left-0 bottom-0 sidebar">
        <div class="self-stretch px-5 py-6 relative flex flex-col justify-start items-start gap-2 sidebar-logo">
            <div class="py-1 inline-flex justify-start items-center gap-2">
                <img src="{% static 'core/img/logo.png' %}" alt="Barlau Logo" class="w-10 h-6">
                <div class="text-center justify-start text-black text-2xl font-semibold leading-normal">Barlau.kz</div>
            </div>
        </div>
        <div class="self-stretch flex-1 px-4 pt-2 pb-4 flex flex-col justify-start items-center gap-4 sidebar-menu">
            <div class="self-stretch flex flex-col justify-start items-start gap-1">
                <div class="self-stretch flex flex-col justify-start items-start">
                    <a href="{% url 'core:home' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2 relative">
                        <img src="{% static 'core/img/home.svg' %}" alt="Home" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/home.svg' %}" alt="Home" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Главная</div>
                    </a>
                    <a href="{% url 'core:tasks' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/check-square.svg' %}" alt="Tasks" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/check-square.svg' %}" alt="Tasks" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Задачи</div>
                    </a>
                    <a href="{% url 'core:map' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/location.svg' %}?v={% now 'U' %}" alt="Map" class="w-5 h-5 desktop-icon align-middle" onerror="this.onerror=null; this.src='/static/core/img/location.svg'">
                        <img src="{% static 'core/img/mobile/location.svg' %}" alt="Map" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Карта</div>
                    </a>
                    <a href="{% url 'core:checklist' %}" class="self-stretch px-3 py-3.5 bg-gray-50 rounded-lg inline-flex items-center gap-2 relative">
                        <div class="w-1 h-6 left-0 top-[calc(50%-12px)] absolute bg-blue-600 rounded-tr-lg rounded-br-lg"></div>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            <path d="M15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z"></path>
                        </svg>
                        <div class="flex-1 text-blue-600 text-base font-medium leading-normal tracking-tight">Чек-листы</div>
                    </a>
                    {% if request.user.role != 'DRIVER' %}
                    <a href="{% url 'core:trucks' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/truck.svg' %}" alt="Trucks" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/truck.svg' %}" alt="Trucks" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Грузовики</div>
                    </a>
                    <a href="{% url 'core:employees' %}" class="self-stretch px-3 py-3.5 bg-white rounded-lg inline-flex items-center gap-2">
                        <img src="{% static 'core/img/employee.svg' %}" alt="Employees" class="w-5 h-5 desktop-icon align-middle">
                        <img src="{% static 'core/img/mobile/employee.svg' %}" alt="Employees" class="mobile-icon hidden align-middle">
                        <div class="flex-1 justify-start text-gray-500 text-base font-medium leading-normal tracking-tight">Сотрудники</div>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="ml-64 flex-1 min-h-screen bg-gray-50 relative main-content">
        <!-- Верхняя панель -->
        <div class="w-full h-20 px-8 py-5 bg-white flex justify-between items-center border-b border-gray-200">
            <div class="justify-start text-zinc-950 text-2xl font-semibold leading-loose">Чек-листы поездок</div>
            <div class="flex justify-start items-center gap-3">
                <div class="flex gap-3">
                    <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="renderChecklists()">
                        <option value="">Все статусы</option>
                        <option value="pending">Ожидает проверки</option>
                        <option value="in_progress">В процессе</option>
                        <option value="completed">Завершен</option>
                        <option value="approved">Одобрен</option>
                    </select>
                    
                    <button onclick="loadChecklists()" class="px-3 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-start items-start gap-2">
                    <a href="{% url 'core:notifications' %}" class="w-10 h-10 px-3 py-2 bg-white rounded-lg shadow-[0px_1px_2px_0px_rgba(13,13,18,0.06)] outline outline-1 outline-offset-[-1px] outline-zinc-200 flex justify-center items-center gap-1.5 relative">
                        <img src="{% static 'core/img/bell.svg' %}" alt="Notifications" class="w-5 h-5">
                        <span id="notif-badge" class="absolute -top-2 -right-2 bg-red-500 rounded-full border-2 border-white flex items-center justify-center font-bold shadow-lg transition-all duration-200" style="min-width: 1.4rem; min-height: 1.4rem; font-size: 0.85rem; color: #fff; padding: 0 0.3em; display: none; align-items: center; justify-content: center;"></span>
                    </a>
                </div>
                <div class="flex justify-start items-center gap-1.5 relative">
                    {% if request.user.is_authenticated %}
                        <div class="relative group" id="user-menu">
                        {% if request.user.photo %}
                                <img class="w-8 h-8 rounded-full object-cover cursor-pointer" src="{{ request.user.photo.url }}" id="user-avatar" />
                        {% else %}
                                <img class="w-8 h-8 rounded-full object-cover cursor-pointer" src="{% static 'core/img/avatars/placeholder-ava.png' %}" id="user-avatar" />
                        {% endif %}
                            <div class="hidden group-hover:block absolute right-0 mt-2 w-44 bg-white border border-gray-200 rounded-lg shadow-lg z-50" id="user-dropdown">
                                <a href="{% url 'core:profile' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Профиль</a>
                                <a href="{% url 'core:custom-logout' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Выйти</a>
                            </div>
                        </div>
                    {% else %}
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Контент чек-листов -->
        <div class="w-full px-8 py-6">
            <div id="checklistsContainer">
                <!-- Loading State -->
                <div class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">Загрузка чек-листов...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Боковая панель чек-листа -->
<div id="checklistSidebar" class="fixed inset-y-0 right-0 w-1/2 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 border-l border-gray-200 hidden">
    <div class="h-full flex flex-col">
        <!-- Заголовок боковой панели -->
        <div class="bg-white px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 id="sidebarTitle" class="text-lg font-semibold text-gray-900">Чек-лист поездки</h2>
                        <p class="text-sm text-gray-500">Проверка транспорта</p>
                    </div>
                </div>
                
                <button onclick="closeChecklistSidebar()" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Контент боковой панели -->
        <div id="sidebarContent" class="flex-1 overflow-y-auto bg-gray-50">
            <!-- Loading State -->
            <div class="flex items-center justify-center py-12">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">Загрузка данных...</p>
                </div>
            </div>
        </div>
        
        <!-- Нижняя панель с кнопками -->
        <div class="bg-white px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Обновлено автоматически</span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="closeChecklistSidebar()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Закрыть
                    </button>
                    <button id="submitChecklistBtn" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white transition-colors" style="display: none;" onclick="submitChecklistForApproval()">
                        Отправить на проверку
                    </button>
                    <button id="approveChecklistBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition-colors" style="display: none;" onclick="approveChecklist()">
                        Одобрить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overlay для затемнения фона -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeChecklistSidebar()"></div>

<!-- Mobile Navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-card border-t lg:hidden py-2 z-40">
    <div class="flex justify-between items-center px-2">
        <a href="{% url 'core:home' %}" class="flex-1 flex flex-col items-center text-muted-foreground mx-1">
            <div class="w-8 h-8 flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
            </div>
            <span class="text-xs mt-1">Главная</span>
        </a>
        
        <a href="{% url 'core:tasks' %}" class="flex-1 flex flex-col items-center text-muted-foreground mx-1">
            <div class="w-8 h-8 flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                </svg>
            </div>
            <span class="text-xs mt-1">Задачи</span>
        </a>
        
        <a href="{% url 'core:map' %}" class="flex-1 flex flex-col items-center text-muted-foreground mx-1">
            <div class="w-8 h-8 flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                </svg>
            </div>
            <span class="text-xs mt-1">Карта</span>
        </a>
        
        <a href="{% url 'core:checklist' %}" class="flex-1 flex flex-col items-center mx-1 text-blue-600">
            <div class="w-8 h-8 flex items-center justify-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <span class="text-xs mt-1">Чек-листы</span>
        </a>
        
        {% if request.user.role != 'DRIVER' %}
        <a href="{% url 'core:trucks' %}" class="flex-1 flex flex-col items-center text-muted-foreground mx-1">
            <div class="w-8 h-8 flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path>
                </svg>
            </div>
            <span class="text-xs mt-1">Грузовики</span>
        </a>
        {% endif %}
    </div>
</nav>

<script>
let checklists = [];

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadChecklists();
});

// Загрузка чек-листов
async function loadChecklists() {
    try {
        const response = await fetch('/api/trip-checklists/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            checklists = data.results || data;
            renderChecklists();
        } else {
            throw new Error('Ошибка загрузки чек-листов');
        }
    } catch (error) {
        console.error('Error loading checklists:', error);
        showErrorState(error.message);
    }
}

// Отображение состояния ошибки
function showErrorState(message) {
    document.getElementById('checklistsContainer').innerHTML = `
        <div class="text-center py-12">
            <div class="mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4" style="background-color: hsl(var(--destructive)/0.1);">
                <svg class="w-8 h-8" style="color: hsl(var(--destructive));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-foreground mb-2">Ошибка загрузки</h3>
            <p class="text-muted-foreground mb-4">${message}</p>
            <button onclick="loadChecklists()" class="btn btn-default btn-default-size">
                Повторить попытку
            </button>
        </div>
    `;
}

// Отображение чек-листов
function renderChecklists() {
    const container = document.getElementById('checklistsContainer');
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filteredChecklists = checklists;
    if (statusFilter) {
        filteredChecklists = checklists.filter(c => c.status === statusFilter);
    }
    
    if (filteredChecklists.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <div class="mx-auto w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-foreground mb-2">Нет чек-листов</h3>
                <p class="text-muted-foreground">Чек-листы не найдены или еще не созданы</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${filteredChecklists.map(checklist => createChecklistCard(checklist)).join('')}
        </div>
    `;
    
    // Анимируем карточки
    setTimeout(() => {
        container.querySelectorAll('.card').forEach((card, index) => {
            setTimeout(() => MaroAI.animateElement(card, 'animate-fade-in-up'), index * 100);
        });
    }, 50);
}

// Создание карточки чек-листа
function createChecklistCard(checklist) {
    const statusInfo = getStatusInfo(checklist.status);
    const progress = checklist.completion_percentage || 0;
    
    return `
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer group" onclick="openChecklistSidebar(${checklist.id})">
            <!-- Заголовок карточки -->
            <div class="p-4 border-b border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">${checklist.trip_details?.vehicle_details?.number || 'Транспорт не указан'}</h3>
                            <p class="text-sm text-gray-500">Чек-лист поездки</p>
                        </div>
                    </div>
                    
                    <div class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${statusInfo.bgClass} ${statusInfo.textClass}">
                        ${statusInfo.label}
                    </div>
                </div>
                
                <!-- Информация о водителе -->
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>${checklist.trip_details?.driver_details?.first_name || ''} ${checklist.trip_details?.driver_details?.last_name || 'Водитель не назначен'}</span>
                </div>
            </div>
            
            <!-- Основной контент -->
            <div class="p-4">
                <!-- Маршрут -->
                <div class="mb-4">
                    <div class="flex items-start gap-2 text-sm">
                        <svg class="w-4 h-4 mt-0.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        </svg>
                        <div class="text-gray-600 line-clamp-2">
                            <span class="font-medium">Откуда:</span> ${checklist.trip_details?.start_address || 'Не указан'}<br>
                            <span class="font-medium">Куда:</span> ${checklist.trip_details?.end_address || 'Не указан'}
                        </div>
                    </div>
                </div>
                
                <!-- Прогресс выполнения -->
                <div class="mb-4">
                    <div class="flex items-center justify-between text-sm mb-2">
                        <span class="text-gray-600">Прогресс выполнения</span>
                        <span class="font-semibold text-gray-900">${progress}%</span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-500 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-blue-600'}" style="width: ${progress}%;"></div>
                    </div>
                </div>
                
                <!-- Нижняя информация -->
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2 text-gray-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>${formatDate(checklist.created_at)}</span>
                    </div>
                    
                    <button class="text-blue-600 font-medium opacity-0 group-hover:opacity-100 transition-opacity hover:text-blue-700" onclick="event.stopPropagation(); openChecklistSidebar(${checklist.id})">
                        Открыть →
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Получение информации о статусе
function getStatusInfo(status) {
    const statusMap = {
        'pending': { 
            label: 'Ожидает заполнения', 
            bgClass: 'bg-yellow-100', 
            textClass: 'text-yellow-800' 
        },
        'in_progress': { 
            label: 'В процессе', 
            bgClass: 'bg-blue-100', 
            textClass: 'text-blue-800' 
        },
        'completed': { 
            label: 'Заполнен', 
            bgClass: 'bg-purple-100', 
            textClass: 'text-purple-800' 
        },
        'approved': { 
            label: 'Одобрен', 
            bgClass: 'bg-green-100', 
            textClass: 'text-green-800' 
        },
        'rejected': { 
            label: 'Отклонен', 
            bgClass: 'bg-red-100', 
            textClass: 'text-red-800' 
        }
    };
    
    return statusMap[status] || { 
        label: 'Неизвестно', 
        bgClass: 'bg-gray-100', 
        textClass: 'text-gray-800' 
    };
}

// Форматирование даты
function formatDate(dateString) {
    if (!dateString) return 'Не указана';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Глобальная переменная для хранения ID текущего чек-листа
let currentChecklistId = null;

// Открытие боковой панели чек-листа
async function openChecklistSidebar(checklistId) {
    currentChecklistId = checklistId;
    const sidebar = document.getElementById('checklistSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const sidebarContent = document.getElementById('sidebarContent');
    const sidebarTitle = document.getElementById('sidebarTitle');
    
    // Показываем боковую панель
    sidebar.classList.remove('hidden');
    overlay.classList.remove('hidden');
    
    // Анимация появления
    setTimeout(() => {
        sidebar.classList.remove('translate-x-full');
    }, 10);
    
    sidebarContent.innerHTML = `
        <div class="flex items-center justify-center py-12">
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-500">Загрузка чек-листа...</p>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/trip-checklists/${checklistId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const checklist = await response.json();
            sidebarTitle.textContent = `Чек-лист: ${checklist.trip_details?.vehicle_details?.number || 'Поездка'}`;
            renderChecklistSidebar(checklist);
        } else {
            throw new Error('Ошибка загрузки чек-листа');
        }
    } catch (error) {
        sidebarContent.innerHTML = `
            <div class="text-center py-12">
                <div class="mx-auto w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Ошибка загрузки</h3>
                <p class="text-gray-500">${error.message}</p>
            </div>
        `;
    }
}

// Отображение содержимого боковой панели
function renderChecklistSidebar(checklist) {
    const sidebarContent = document.getElementById('sidebarContent');
    const statusInfo = getStatusInfo(checklist.status);
    
    // Группируем пункты по категориям
    const itemsByCategory = {};
    if (checklist.items && checklist.items.length > 0) {
        checklist.items.forEach(item => {
            const category = item.template_details?.category || 'OTHER';
            if (!itemsByCategory[category]) {
                itemsByCategory[category] = [];
            }
            itemsByCategory[category].push(item);
        });
    }
    
    sidebarContent.innerHTML = `
        <div class="space-y-6">
            <!-- Trip Info -->
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-lg bg-blue-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Информация о поездке</h3>
                                <p class="text-sm text-gray-500">${checklist.trip_details?.vehicle_details?.number || 'Не указан'}</p>
                            </div>
                        </div>
                        
                        <div class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-gray-100 text-gray-800">${statusInfo.label}</div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <h4 class="font-medium text-foreground mb-2">Водитель</h4>
                            <p class="text-muted-foreground">${checklist.trip_details?.driver_details?.first_name || ''} ${checklist.trip_details?.driver_details?.last_name || 'Не указан'}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-foreground mb-2">Дата создания</h4>
                            <p class="text-muted-foreground">${formatDate(checklist.created_at)}</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <h4 class="font-medium text-foreground mb-2">Маршрут</h4>
                            <p class="text-muted-foreground">${checklist.trip_details?.start_address || 'Не указан'} → ${checklist.trip_details?.end_address || 'Не указан'}</p>
                        </div>
                    </div>
                    
                    <!-- Progress -->
                    <div>
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span class="text-muted-foreground">Прогресс выполнения</span>
                            <span class="font-medium text-foreground">${checklist.completion_percentage || 0}%</span>
                        </div>
                        <div class="w-full h-3 bg-secondary rounded-full overflow-hidden">
                            <div class="h-full transition-all duration-500 rounded-full bg-blue-600" style="width: ${checklist.completion_percentage || 0}%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Checklist Items -->
            ${Object.keys(itemsByCategory).length > 0 ? Object.entries(itemsByCategory).map(([category, items]) => `
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">${getCategoryName(category)}</h3>
                        <p class="text-sm text-gray-500">${items.length} пункт${items.length === 1 ? '' : items.length < 5 ? 'а' : 'ов'} для проверки</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4">
                            ${items.map(item => `
                                <div class="border rounded-lg p-3 space-y-2" data-item-id="${item.id}">
                                    <div class="flex items-start gap-3">
                                        <button class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all text-xs ${item.is_checked ? (item.is_ok ? 'bg-green-500 border-green-500 text-white' : 'bg-red-500 border-red-500 text-white') : 'border-gray-300 hover:border-gray-400'}" 
                                                onclick="toggleChecklistItem(${item.id})">
                                            ${item.is_checked ? (item.is_ok ? '✓' : '✗') : ''}
                                        </button>
                                        
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="flex-1 min-w-0">
                                                    <h4 class="font-medium text-sm text-foreground truncate">${item.template_details?.title || 'Без названия'}</h4>
                                                    ${item.template_details?.description ? `<p class="text-xs text-muted-foreground mt-1 line-clamp-2">${item.template_details.description}</p>` : ''}
                                                </div>
                                                
                                                <!-- Action Buttons - компактные -->
                                                <div class="flex gap-1 ml-2 flex-shrink-0">
                                                    <button class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition-colors flex items-center" onclick="checkItem(${item.id}, true)">
                                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                        ОК
                                                    </button>
                                                    <button class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700 transition-colors flex items-center" onclick="checkItem(${item.id}, false)">
                                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                        НЕТ
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Компактная область для заметок и фото -->
                                            <div class="space-y-2">
                                                <!-- Notes - компактные -->
                                                <textarea class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none" rows="1" placeholder="Комментарий..." 
                                                          onchange="updateItemNotes(${item.id}, this.value)" onfocus="this.rows=2" onblur="if(!this.value) this.rows=1">${item.notes || ''}</textarea>
                                                
                                                <!-- Photo Upload - компактный -->
                                                <div class="flex items-center gap-2">
                                                    <button class="px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-600 hover:border-gray-400 transition-colors flex items-center" 
                                                            onclick="triggerPhotoUpload(${item.id})">
                                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                        </svg>
                                                        Фото
                                                    </button>
                                                    <input type="file" id="photo-input-${item.id}" class="hidden" multiple accept="image/*" 
                                                           onchange="handlePhotoUpload(${item.id}, this.files)">
                                                    
                                                    <!-- Photo Preview - компактный -->
                                                    <div id="photo-preview-${item.id}" class="flex gap-1">
                                                        ${item.photos ? item.photos.map(photo => `
                                                            <div class="relative group">
                                                                <img src="${photo.image}" alt="Фото" class="w-8 h-8 object-cover rounded border cursor-pointer" onclick="showImageModal('${photo.image}')">
                                                                <button class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity leading-none"
                                                                        onclick="deletePhoto(${photo.id})">×</button>
                                                            </div>
                                                        `).join('') : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('') : `
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div class="p-12 text-center">
                        <div class="mx-auto w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Нет пунктов для проверки</h3>
                        <p class="text-gray-500">Пункты чек-листа еще не добавлены</p>
                    </div>
                </div>
            `}
        </div>
    `;
    
    // Показываем/скрываем кнопки в зависимости от статуса
    updateSidebarButtons(checklist.status, checklist);
}

// Обновление кнопок в боковой панели
function updateSidebarButtons(status, checklist) {
    const submitBtn = document.getElementById('submitChecklistBtn');
    const approveBtn = document.getElementById('approveChecklistBtn');
    
    // Скрываем все кнопки по умолчанию
    submitBtn.style.display = 'none';
    approveBtn.style.display = 'none';
    
    // Получаем информацию о текущем пользователе (можно передать через template context)
    const userRole = '{{ user.role }}';
    const isDriver = checklist.trip_details?.driver_details?.id === parseInt('{{ user.id }}');
    const isAdmin = ['SUPERADMIN', 'ADMIN', 'DIRECTOR', 'DISPATCHER'].includes(userRole);
    
    // Показываем кнопки в зависимости от статуса и роли
    if (status === 'IN_PROGRESS' && isDriver && checklist.completion_percentage === 100) {
        // Водитель может отправить на проверку, если все пункты заполнены
        submitBtn.style.display = 'inline-flex';
    } else if (status === 'COMPLETED' && isAdmin) {
        // Админ/диспетчер может одобрить завершенный чек-лист
        approveBtn.style.display = 'inline-flex';
    }
}

// Получение названия категории
function getCategoryName(category) {
    const categoryNames = {
        'ENGINE': 'Двигатель',
        'BRAKES': 'Тормозная система',
        'TIRES': 'Шины и колеса',
        'LIGHTS': 'Освещение',
        'SAFETY': 'Безопасность',
        'DOCUMENTS': 'Документы',
        'OTHER': 'Прочее'
    };
    
    return categoryNames[category] || category;
}

// Закрытие боковой панели
function closeChecklistSidebar() {
    const sidebar = document.getElementById('checklistSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    // Анимация скрытия
    sidebar.classList.add('translate-x-full');
    
    // Скрываем элементы после анимации
    setTimeout(() => {
        sidebar.classList.add('hidden');
        overlay.classList.add('hidden');
    }, 300);
}

// Переключение состояния пункта
async function toggleChecklistItem(itemId) {
    // Реализация переключения состояния
    console.log('Toggle item:', itemId);
}

// Отметка пункта как выполненного/проблемного
async function checkItem(itemId, isOk) {
    try {
        const response = await fetch(`/api/checklist-items/${itemId}/update/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                is_checked: true,
                is_ok: isOk
            })
        });
        
        if (response.ok) {
            // Обновляем UI
            const checkbox = document.querySelector(`[data-item-id="${itemId}"] button`);
            if (checkbox) {
                checkbox.className = `w-5 h-5 rounded border-2 flex items-center justify-center transition-all text-xs ${isOk ? 'bg-green-500 border-green-500 text-white' : 'bg-red-500 border-red-500 text-white'}`;
                checkbox.textContent = isOk ? '✓' : '✗';
            }
            
            MaroAI.showToast({
                title: 'Успешно',
                description: `Пункт отмечен как ${isOk ? 'выполненный' : 'проблемный'}`,
                variant: 'default'
            });
        }
    } catch (error) {
        MaroAI.showToast({
            title: 'Ошибка',
            description: 'Не удалось обновить пункт',
            variant: 'destructive'
        });
    }
}

// Обновление заметок
async function updateItemNotes(itemId, notes) {
    try {
        await fetch(`/api/checklist-items/${itemId}/update/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes })
        });
    } catch (error) {
        console.error('Error updating notes:', error);
    }
}

// Запуск загрузки фото
function triggerPhotoUpload(itemId) {
    document.getElementById(`photo-input-${itemId}`).click();
}

// Обработка загрузки фото
async function handlePhotoUpload(itemId, files) {
    if (!files.length) return;
    
    const formData = new FormData();
    Array.from(files).forEach(file => {
        formData.append('photos', file);
    });
    
    try {
        const response = await fetch(`/api/checklist-items/${itemId}/upload-photos/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Обновляем превью фотографий сразу после загрузки
            if (result.photos && result.photos.length > 0) {
                const previewContainer = document.getElementById(`photo-preview-${itemId}`);
                if (previewContainer) {
                    // Получаем текущие фото и добавляем новые
                    const existingPhotos = previewContainer.innerHTML;
                    const newPhotos = result.photos.map(photo => `
                        <div class="relative group">
                            <img src="${photo.image}" alt="Фото" class="w-8 h-8 object-cover rounded border cursor-pointer" onclick="showImageModal('${photo.image}')">
                            <button class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity leading-none"
                                    onclick="deletePhoto(${photo.id})">×</button>
                        </div>
                    `).join('');
                    
                    previewContainer.innerHTML = existingPhotos + newPhotos;
                }
            }
            
            MaroAI.showToast({
                title: 'Успешно',
                description: 'Фото загружены',
                variant: 'default'
            });
            
            // Очищаем input для повторной загрузки
            document.getElementById(`photo-input-${itemId}`).value = '';
        }
    } catch (error) {
        MaroAI.showToast({
            title: 'Ошибка',
            description: 'Не удалось загрузить фото',
            variant: 'destructive'
        });
    }
}

// Удаление фото
async function deletePhoto(photoId) {
    try {
        const response = await fetch(`/api/checklist-photos/${photoId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            // Удаляем элемент из DOM
            document.querySelector(`button[onclick="deletePhoto(${photoId})"]`).closest('.relative').remove();
            
            MaroAI.showToast({
                title: 'Успешно',
                description: 'Фото удалено',
                variant: 'default'
            });
        }
    } catch (error) {
        MaroAI.showToast({
            title: 'Ошибка',
            description: 'Не удалось удалить фото',
            variant: 'destructive'
        });
    }
}

// Получение CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Показать изображение в модальном окне
function showImageModal(imageSrc) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full p-4">
            <img src="${imageSrc}" alt="Фото" class="max-w-full max-h-full object-contain rounded">
            <button class="absolute top-2 right-2 w-8 h-8 bg-white text-black rounded-full hover:bg-gray-200 transition-colors" onclick="this.parentElement.parentElement.remove()">
                ×
            </button>
        </div>
    `;
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
    document.body.appendChild(modal);
}

// Отправка чек-листа на проверку
async function submitChecklistForApproval() {
    if (!currentChecklistId) return;
    
    try {
        const response = await fetch(`/api/trip-checklists/${currentChecklistId}/submit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            MaroAI.showToast({
                title: 'Успешно',
                description: 'Чек-лист отправлен на проверку',
                variant: 'default'
            });
            
            // Обновляем интерфейс
            loadChecklists();
            closeChecklistSidebar();
        } else {
            throw new Error('Ошибка отправки чек-листа');
        }
    } catch (error) {
        MaroAI.showToast({
            title: 'Ошибка',
            description: error.message,
            variant: 'destructive'
        });
    }
}

// Одобрение чек-листа
async function approveChecklist() {
    if (!currentChecklistId) return;
    
    try {
        const response = await fetch(`/api/trip-checklists/${currentChecklistId}/approve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            MaroAI.showToast({
                title: 'Успешно',
                description: 'Чек-лист одобрен. Поездка готова к отправке!',
                variant: 'default'
            });
            
            // Обновляем интерфейс
            loadChecklists();
            closeChecklistSidebar();
        } else {
            throw new Error('Ошибка одобрения чек-листа');
        }
    } catch (error) {
        MaroAI.showToast({
            title: 'Ошибка',
            description: error.message,
            variant: 'destructive'
        });
    }
}

// Функция для обновления превью фотографий
function updatePhotoPreview(itemId, photos) {
    const previewContainer = document.getElementById(`photo-preview-${itemId}`);
    if (previewContainer) {
        previewContainer.innerHTML = photos.map(photo => `
            <div class="relative group">
                <img src="${photo.image}" alt="Фото" class="w-8 h-8 object-cover rounded border cursor-pointer" onclick="showImageModal('${photo.image}')">
                <button class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity leading-none"
                        onclick="deletePhoto(${photo.id})">×</button>
            </div>
        `).join('');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadChecklists();
});
</script>
{% endblock %}