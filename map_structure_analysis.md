# Анализ структуры карты и API в транспортной системе

## Структура API для карты

### Эндпоинты API
- **GET /api/v1/map/** - Основной эндпоинт для получения всех данных для карты (транспорт и задачи)
- **GET /api/v1/map/live_tracking/** - Получение данных о местоположении транспортных средств
- **POST /api/v1/map/update_location/** - Обновление местоположения транспортного средства
- **POST /api/v1/map/tracking_status/** - Обновление статуса отслеживания местоположения

### Основные модели
1. **Vehicle (Транспортное средство)**
   - `number` - Государственный номер
   - `brand` - Марка автомобиля
   - `model` - Модель автомобиля
   - `year` - Год выпуска
   - `vehicle_type` - Тип транспорта (легковой, грузовой, спецтехника)
   - `status` - Статус (активен, неактивен, на обслуживании)
   - `driver` - Связь с пользователем-водителем

2. **User (Пользователь с ролью Водитель)**
   - `current_latitude` - Текущая широта
   - `current_longitude` - Текущая долгота
   - `last_location_update` - Время последнего обновления местоположения
   - `location_tracking_enabled` - Включено ли отслеживание местоположения

3. **Task (Задача)**
   - `title` - Название задачи
   - `status` - Статус (новая, в работе, завершена, отменена)
   - `vehicle` - Связь с транспортным средством
   - `assigned_to` - Исполнитель (связь с пользователем)

### Сериализаторы для карты
1. **VehicleLocationSerializer**
   - Выводит основную информацию о ТС и его местоположении (ID, номер, марка, модель, имя водителя, координаты)

2. **TaskLocationSerializer**
   - Выводит информацию о задаче и координаты связанного с ней ТС

## Структура интерфейса карты (map.html)

### Основные компоненты UI
1. **Боковая панель (sidebar)**
   - Навигационное меню с ссылками на другие разделы
   - Стилизована с использованием Tailwind CSS

2. **Основная область карты**
   - Использует библиотеку Leaflet для отображения
   - Занимает большую часть экрана
   - Поддерживает перетаскивание, масштабирование и другие стандартные функции карты

3. **Панель счетчиков транспорта**
   - Общее количество транспортных средств
   - Количество активных (в движении) ТС
   - Количество ТС на стоянке

4. **Нижнее мобильное меню**
   - Отображается только на планшетах и мобильных устройствах
   - Содержит быстрые ссылки на основные разделы

### Отображение данных на карте
1. **Маркеры транспортных средств**
   - Используют Font Awesome для иконок
   - Цвет зависит от статуса:
     - Синий - активный (в движении)
     - Серый - на стоянке
     - Красный - долгий простой (более часа)
   - При клике на маркер показывается всплывающее окно с подробной информацией

2. **Всплывающие окна (popups)**
   - Содержат детальную информацию:
     - Марка и модель ТС
     - Гос. номер
     - ФИО водителя
     - Телефон водителя
     - Текущая скорость
     - Время последнего обновления

## Логика работы карты

### Инициализация
1. Создание карты с использованием Leaflet
2. Настройка начальных координат и масштаба
3. Добавление фоновых слоев (tile layers)
4. Инициализация переменных для хранения маркеров

### Получение данных
1. В демонстрационном режиме используются тестовые данные
2. В рабочем режиме выполняется запрос к `/api/v1/map/`
3. Для неавторизованных пользователей возвращаются демо-данные
4. Для авторизованных пользователей возвращаются реальные данные с учетом роли

### Отображение данных
1. Очистка существующих маркеров с карты
2. Создание новых маркеров для каждого ТС с учетом статуса
3. Добавление всплывающих окон с информацией
4. Обновление счетчиков общего количества, активных и неактивных ТС
5. Обновление времени последнего обновления

### Периодическое обновление
1. Автоматическое обновление данных каждые 5 минут
2. Возможность ручного обновления по нажатию на кнопку

### Адаптивность
1. Функция `adjustLayoutForTablet()` для настройки интерфейса под планшеты и мобильные устройства
2. Функция `resetLayoutToDesktop()` для возврата к десктопному режиму
3. Обработка изменения размера окна для динамической адаптации
4. Исправление размеров карты при изменении контейнера

## Ключевые функции JavaScript

1. **loadVehicles()** - Загрузка и отображение ТС на карте
2. **displayVehicles(vehicles)** - Создание маркеров на карте
3. **clearVehicleMarkers()** - Очистка существующих маркеров
4. **updateCounters(vehicles)** - Обновление счетчиков
5. **updateLastUpdateTime()** - Обновление времени последнего обновления
6. **adjustLayoutForTablet()** - Адаптация под планшеты и мобильные устройства
7. **resetLayoutToDesktop()** - Возврат к десктопному режиму
8. **fixAllLinks()** - Коррекция некорректных ссылок

## Демонстрационные данные

В режиме демонстрации используются тестовые данные с предопределенными координатами для трех транспортных средств:
1. "KZ 777 WEB" - Легковой автомобиль (BMW X5)
2. "KZ 456 DEF" - Грузовик (Volvo FH)
3. "KZ 123 JKL" - Грузовик (Scania R500)

Каждое демо-ТС содержит информацию о:
- ID, гос. номере, марке и модели
- Статусе (активен/неактивен)
- Времени последнего обновления
- Текущей скорости
- Водителе (ФИО и телефон)
- Координатах (широта и долгота) 